{% extends 'base.html' %}
{% load role_tags %}

{% block title %}Manage Academic Sessions - DAAA{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Delegation Status Badges -->
    {% show_delegation_badges user %}

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: var(--royal-blue-gradient); color: white;">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-1 fw-bold">Manage Academic Sessions</h1>
                            <p class="mb-0 opacity-75">Create, activate, and manage academic sessions</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="{% url 'daaa_create_session' %}" class="btn btn-light btn-sm">
                                    <i class="bi bi-plus-circle me-1"></i>Create Session
                                </a>
                                <a href="{% url 'daaa_dashboard' %}" class="btn btn-outline-light btn-sm">
                                    <i class="bi bi-arrow-left me-1"></i>Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="h2 text-primary fw-bold mb-1">{{ total_sessions|default:"0" }}</div>
                    <div class="text-muted">Total Sessions</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="h2 text-success fw-bold mb-1">{{ active_sessions|default:"0" }}</div>
                    <div class="text-muted">Active Sessions</div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="h2 text-danger fw-bold mb-1">{{ locked_sessions|default:"0" }}</div>
                    <div class="text-muted">Locked Sessions</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions List -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        Academic Sessions ({{ sessions.count|default:"0" }})
                    </h5>

                    {% if sessions %}
                        {% for session in sessions %}
                        <div class="border rounded p-3 mb-3 {% if session.is_active %}bg-success-subtle border-success{% elif session.is_locked %}bg-danger-subtle border-danger{% else %}bg-light{% endif %}">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <h6 class="mb-0 fw-bold text-primary">{{ session.name }}</h6>
                                        {% if session.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                        {% if session.is_locked %}
                                            <span class="badge bg-danger">Locked</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-muted small mb-1">
                                        <strong>Period:</strong> {{ session.start_date|date:"M d, Y" }} - {{ session.end_date|date:"M d, Y" }}
                                    </div>
                                    <div class="text-muted small">
                                        <strong>Created:</strong> {{ session.created_at|date:"M d, Y H:i" }}
                                        {% if session.created_by %}
                                            by {{ session.created_by.get_full_name|default:session.created_by.username }}
                                        {% else %}
                                            by System
                                        {% endif %}
                                    </div>
                                    {% if session.is_active %}
                                        <div class="text-success small fw-bold mt-1">
                                            <i class="bi bi-check-circle me-1"></i>Currently Active Session
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="d-flex gap-1 justify-content-end flex-wrap">
                                        {% if not session.is_active %}
                                            <button class="btn btn-success btn-sm activate-session-btn"
                                                    data-session-id="{{ session.id }}"
                                                    data-session-name="{{ session.name }}">
                                                <i class="bi bi-play-circle me-1"></i>Activate
                                            </button>
                                        {% else %}
                                            <button class="btn btn-secondary btn-sm deactivate-session-btn"
                                                    data-session-id="{{ session.id }}"
                                                    data-session-name="{{ session.name }}">
                                                <i class="bi bi-pause-circle me-1"></i>Deactivate
                                            </button>
                                        {% endif %}

                                        {% if not session.is_locked %}
                                            <button class="btn btn-warning btn-sm lock-session-btn"
                                                    data-session-id="{{ session.id }}"
                                                    data-session-name="{{ session.name }}">
                                                <i class="bi bi-lock me-1"></i>Lock
                                            </button>
                                        {% else %}
                                            <button class="btn btn-info btn-sm unlock-session-btn"
                                                    data-session-id="{{ session.id }}"
                                                    data-session-name="{{ session.name }}">
                                                <i class="bi bi-unlock me-1"></i>Unlock
                                            </button>
                                        {% endif %}

                                        <button class="btn btn-outline-primary btn-sm view-session-btn"
                                                data-session-id="{{ session.id }}"
                                                data-session-name="{{ session.name }}">
                                            <i class="bi bi-eye me-1"></i>Details
                                        </button>

                                        {% if not session.is_active %}
                                            <button class="btn btn-outline-danger btn-sm delete-session-btn"
                                                    data-session-id="{{ session.id }}"
                                                    data-session-name="{{ session.name }}">
                                                <i class="bi bi-trash me-1"></i>Delete
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-calendar-x text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
                            <h5 class="text-muted mt-3">No Academic Sessions</h5>
                            <p class="text-muted">Create your first academic session to get started.</p>
                            <a href="{% url 'daaa_create_session' %}" class="btn btn-primary mt-2">
                                <i class="bi bi-plus-circle me-1"></i>Create Session
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Session management functions
function activateSession(sessionId, sessionName) {
    if (confirm(`Activate academic session "${sessionName}"?\n\nThis will deactivate all other sessions.`)) {
        fetch('{% url "daaa_activate_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'session_id=' + sessionId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}

function deactivateSession(sessionId, sessionName) {
    if (confirm(`Deactivate academic session "${sessionName}"?\n\nThis will make the session inactive. You can reactivate it later.`)) {
        fetch(`{% url "daaa_deactivate_session" 0 %}`.replace('0', sessionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}

function lockSession(sessionId, sessionName) {
    if (confirm(`Lock academic session "${sessionName}"?\n\nThis will prevent any changes to the session.`)) {
        fetch(`{% url "daaa_lock_session" 0 %}`.replace('0', sessionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}

function unlockSession(sessionId, sessionName) {
    if (confirm(`Unlock academic session "${sessionName}"?`)) {
        fetch(`{% url "daaa_unlock_session" 0 %}`.replace('0', sessionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}

function deleteSession(sessionId, sessionName) {
    if (confirm(`Delete academic session "${sessionName}"?\n\nThis action cannot be undone.`)) {
        fetch(`{% url "daaa_delete_session" 0 %}`.replace('0', sessionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}

function viewSessionDetails(sessionId, sessionName) {
    alert(`Session Details for: ${sessionName}\nID: ${sessionId}\n\nDetailed view functionality can be implemented here.`);
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Activate session buttons
    document.querySelectorAll('.activate-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            const sessionName = this.getAttribute('data-session-name');
            activateSession(sessionId, sessionName);
        });
    });

    // Deactivate session buttons
    document.querySelectorAll('.deactivate-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            const sessionName = this.getAttribute('data-session-name');
            deactivateSession(sessionId, sessionName);
        });
    });

    // Lock session buttons
    document.querySelectorAll('.lock-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            const sessionName = this.getAttribute('data-session-name');
            lockSession(sessionId, sessionName);
        });
    });

    // Unlock session buttons
    document.querySelectorAll('.unlock-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            const sessionName = this.getAttribute('data-session-name');
            unlockSession(sessionId, sessionName);
        });
    });

    // View session details buttons
    document.querySelectorAll('.view-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            const sessionName = this.getAttribute('data-session-name');
            viewSessionDetails(sessionId, sessionName);
        });
    });

    // Delete session buttons
    document.querySelectorAll('.delete-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            const sessionName = this.getAttribute('data-session-name');
            deleteSession(sessionId, sessionName);
        });
    });
});
</script>

{% csrf_token %}
{% endblock %} <script> function activateSession(sessionId, sessionName) { if (confirm(`Activate academic session "${sessionName}"?\n\nThis will deactivate all other sessions.`)) { fetch('{% url "daaa_activate_session" %}', { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Content-Type': 'application/x-www-form-urlencoded', }, body: 'session_id=' + sessionId }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + data.message); } }) .catch(error => { alert('An error occurred. Please try again.'); }); } } function lockSession(sessionId, sessionName) { if (confirm(`Lock academic session "${sessionName}"?\n\nThis will prevent any changes to the session.`)) { fetch(`{% url "daaa_lock_session" 0 %}`.replace('0', sessionId), { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Content-Type': 'application/x-www-form-urlencoded', } }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + data.message); } }) .catch(error => { alert('An error occurred. Please try again.'); }); } } function unlockSession(sessionId, sessionName) { if (confirm(`Unlock academic session "${sessionName}"?`)) { fetch(`{% url "daaa_unlock_session" 0 %}`.replace('0', sessionId), { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Content-Type': 'application/x-www-form-urlencoded', } }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + data.message); } }) .catch(error => { alert('An error occurred. Please try again.'); }); } } function viewSessionDetails(sessionId, sessionName) { // Get session data from the page const sessionCard = document.querySelector(`[data-session-id="${sessionId}"]`).closest('.session-card'); const periodText = sessionCard.querySelector('[style*="color: var(--text-secondary)"]').textContent; const createdText = sessionCard.querySelectorAll('[style*="color: var(--text-secondary)"]')[1].textContent; const isActive = sessionCard.querySelector('.status-active') !== null; const isLocked = sessionCard.querySelector('.status-locked') !== null; const modal = document.createElement('div'); modal.innerHTML = ` <div class="modal show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header" style="background: var(--royal-blue-gradient); color: white;"> <h5 class="modal-title"> <i class="fas fa-calendar-alt me-2"></i>Session Details: ${sessionName} </h5> <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').parentElement.remove()"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6 mb-3"> <div class="card border-0 bg-light"> <div class="card-body text-center"> <i class="fas fa-id-badge fa-2x text-primary mb-2"></i> <h6 class="card-title">Session ID</h6> <p class="card-text fw-bold">${sessionId}</p> </div> </div> </div> <div class="col-md-6 mb-3"> <div class="card border-0 bg-light"> <div class="card-body text-center"> <i class="fas fa-tag fa-2x text-info mb-2"></i> <h6 class="card-title">Session Name</h6> <p class="card-text fw-bold">${sessionName}</p> </div> </div> </div> </div> <div class="row"> <div class="col-md-6 mb-3"> <div class="card border-0 bg-light"> <div class="card-body text-center"> <i class="fas fa-calendar-check fa-2x ${isActive ? 'text-success' : 'text-secondary'} mb-2"></i> <h6 class="card-title">Status</h6> <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'} fs-6">${isActive ? 'Active' : 'Inactive'}</span> ${isLocked ? '<br><span class="badge bg-danger fs-6 mt-1">Locked</span>' : ''} </div> </div> </div> <div class="col-md-6 mb-3"> <div class="card border-0 bg-light"> <div class="card-body text-center"> <i class="fas fa-calendar-day fa-2x text-warning mb-2"></i> <h6 class="card-title">Duration</h6> <p class="card-text small">${periodText.replace('Period:', '').trim()}</p> </div> </div> </div> </div> <div class="card border-0 bg-light"> <div class="card-body"> <h6 class="card-title"> <i class="fas fa-info-circle me-2"></i>Creation Information </h6> <p class="card-text">${createdText.replace('Created:', '').trim()}</p> </div> </div> <div class="alert alert-info mt-3"> <i class="fas fa-lightbulb me-2"></i> <strong>Quick Actions:</strong> Use the buttons in the session list to activate, lock/unlock, or delete this session. </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').parentElement.remove()"> <i class="fas fa-times me-1"></i>Close </button> </div> </div> </div> </div> `; document.body.appendChild(modal); } function deactivateSession(sessionId, sessionName) { if (confirm(`Deactivate academic session "${sessionName}"?\n\nThis will make the session inactive. You can reactivate it later.`)) { fetch(`{% url "daaa_deactivate_session" 0 %}`.replace('0', sessionId), { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Content-Type': 'application/x-www-form-urlencoded', } }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + data.message); } }) .catch(error => { alert('An error occurred. Please try again.'); }); } } function deleteSession(sessionId, sessionName) { if (confirm(`Delete academic session "${sessionName}"?\n\nThis action cannot be undone. The session will be automatically deactivated if needed.`)) { fetch(`{% url "daaa_delete_session" 0 %}`.replace('0', sessionId), { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Content-Type': 'application/x-www-form-urlencoded', } }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + data.message); } }) .catch(error => { alert('An error occurred. Please try again.'); }); } } // Add event listeners for session management buttons document.addEventListener('DOMContentLoaded', function() { document.querySelectorAll('.activate-session-btn').forEach(button => { button.addEventListener('click', function() { const sessionId = this.getAttribute('data-session-id'); const sessionName = this.getAttribute('data-session-name'); activateSession(sessionId, sessionName); }); }); document.querySelectorAll('.deactivate-session-btn').forEach(button => { button.addEventListener('click', function() { const sessionId = this.getAttribute('data-session-id'); const sessionName = this.getAttribute('data-session-name'); deactivateSession(sessionId, sessionName); }); }); document.querySelectorAll('.lock-session-btn').forEach(button => { button.addEventListener('click', function() { const sessionId = this.getAttribute('data-session-id'); const sessionName = this.getAttribute('data-session-name'); lockSession(sessionId, sessionName); }); }); document.querySelectorAll('.unlock-session-btn').forEach(button => { button.addEventListener('click', function() { const sessionId = this.getAttribute('data-session-id'); const sessionName = this.getAttribute('data-session-name'); unlockSession(sessionId, sessionName); }); }); document.querySelectorAll('.view-session-btn').forEach(button => { button.addEventListener('click', function() { const sessionId = this.getAttribute('data-session-id'); const sessionName = this.getAttribute('data-session-name'); viewSessionDetails(sessionId, sessionName); }); }); document.querySelectorAll('.delete-session-btn').forEach(button => { button.addEventListener('click', function() { const sessionId = this.getAttribute('data-session-id'); const sessionName = this.getAttribute('data-session-name'); deleteSession(sessionId, sessionName); }); }); }); </script> {% csrf_token %} {% endblock %}