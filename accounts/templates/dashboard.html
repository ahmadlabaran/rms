{% extends 'base.html' %}
{% load role_tags %}

{% block title %}Dashboard - RMS{% endblock %}

{% block content %}
<!-- Current Session Info - TOP PRIORITY -->
{% if current_session %}
<div class="ios-card" style="background: var(--accent-gradient); color: white; margin-bottom: 32px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600;">{{ current_session.name }}</h2>
            <p style="margin: 0; opacity: 0.9; font-size: 16px;">{{ current_session.start_date }} - {{ current_session.end_date }}</p>
        </div>
        <div>
            {% if current_session.is_active %}
                <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 12px; font-weight: 600;">Active Session</span>
            {% else %}
                <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 12px; font-weight: 600;">Inactive</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Delegation Status Badges -->
{% show_delegation_badges user %}

<!-- Delegation Notifications and Role Switching -->
{% get_user_roles_with_delegation user as user_roles_details %}

{% if user_roles_details %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-shield me-2"></i>
                    Role Access & Delegation Management
                </h5>
            </div>
            <div class="card-body">
                {% for role_detail in user_roles_details %}
                    {% if role_detail.is_delegated %}
                    <div class="alert alert-warning mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="alert-heading mb-1">
                                    <i class="fas fa-hand-point-right me-2"></i>
                                    You have been granted temporary permissions to act as {{ role_detail.role_display }}
                                </h6>
                                <p class="mb-0">
                                    <strong>Department:</strong> {{ role_detail.department.name|default:"N/A" }} |
                                    <strong>Faculty:</strong> {{ role_detail.faculty.name|default:"N/A" }}
                                </p>
                            </div>
                            <div>
                                {% if role_detail.role == 'FACULTY_DEAN' %}
                                <a href="{% url 'faculty_dean_dashboard' %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-university me-1"></i>
                                    Switch to Dean Dashboard
                                </a>
                                {% elif role_detail.role == 'HOD' %}
                                <a href="{% url 'hod_dashboard' %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Switch to HOD Dashboard
                                </a>
                                {% elif role_detail.role == 'DAAA' %}
                                <a href="{% url 'daaa_dashboard' %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-cogs me-1"></i>
                                    Switch to DAAA Dashboard
                                </a>
                                {% elif role_detail.role == 'LECTURER' %}
                                <a href="{% url 'lecturer_dashboard' %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-chalkboard-teacher me-1"></i>
                                    Switch to Lecturer Dashboard
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}

                <!-- Direct Roles Section -->
                <h6 class="text-muted mb-3">Your Direct Roles:</h6>
                <div class="row">
                    {% for role_detail in user_roles_details %}
                        {% if not role_detail.is_delegated %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-success">{{ role_detail.role_display }}</h6>
                                    <p class="card-text small">
                                        {% if role_detail.department %}{{ role_detail.department.name }}{% endif %}
                                        {% if role_detail.faculty %}{{ role_detail.faculty.name }}{% endif %}
                                    </p>
                                    {% if role_detail.role == 'FACULTY_DEAN' %}
                                    <a href="{% url 'faculty_dean_dashboard' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-university me-1"></i>
                                        Dean Dashboard
                                    </a>
                                    {% elif role_detail.role == 'HOD' %}
                                    <a href="{% url 'hod_dashboard' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-user-tie me-1"></i>
                                        HOD Dashboard
                                    </a>
                                    {% elif role_detail.role == 'DAAA' %}
                                    <a href="{% url 'daaa_dashboard' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-cogs me-1"></i>
                                        DAAA Dashboard
                                    </a>
                                    {% elif role_detail.role == 'LECTURER' %}
                                    <a href="{% url 'lecturer_dashboard' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-chalkboard-teacher me-1"></i>
                                        Lecturer Dashboard
                                    </a>
                                    {% elif role_detail.role == 'STUDENT' %}
                                    <a href="{% url 'student_dashboard' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-graduation-cap me-1"></i>
                                        Student Dashboard
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="page-header">
    <h1 class="page-title">Welcome back, {{ user.first_name|default:user.username }}</h1>
    <p class="page-subtitle">Result Management System Dashboard</p>

    <!-- Role Summary with Delegation Info -->
    {% get_user_roles_with_delegation user as roles_info %}
    {% if roles_info %}
    <div class="role-summary" style="margin-top: 16px;">
        <div class="d-flex flex-wrap gap-2">
            {% for role_info in roles_info %}
            <span class="badge {% if role_info.is_delegated %}bg-warning text-dark{% else %}bg-primary{% endif %}"
                  style="padding: 6px 12px; font-size: 12px; border-radius: 20px;"
                  {% if role_info.is_delegated %}
                  title="Delegated from {{ role_info.delegated_from.get_full_name }}"
                  {% endif %}>
                {% if role_info.is_delegated %}
                <i class="fas fa-arrow-right" style="margin-right: 4px; font-size: 10px;"></i>
                {% endif %}
                {% get_role_display_name role_info.role %}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Role-based Dashboard Content -->
{% if user_roles %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_students|default:0 }}</div>
        <div class="stat-label">Total Students</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_courses|default:0 }}</div>
        <div class="stat-label">Active Courses</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.pending_results|default:0 }}</div>
        <div class="stat-label">Pending Results</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.published_results|default:0 }}</div>
        <div class="stat-label">Published Results</div>
    </div>
</div>

<!-- Clean Role-specific Actions -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px; margin-bottom: 32px;">
    <div class="ios-card">
        <h2 style="color: var(--text-primary); margin-bottom: 32px; font-size: 24px; font-weight: 600;">Quick Actions</h2>

        {% if 'SUPER_ADMIN' in user_roles %}
        <div style="margin-bottom: 40px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 20px; font-size: 18px; font-weight: 600;">System Administration</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <a href="{% url 'manage_users' %}" class="btn btn-primary">Manage Users</a>
                <a href="{% url 'manage_faculties' %}" class="btn btn-primary">Manage Faculties</a>
                <a href="{% url 'manage_departments' %}" class="btn btn-primary">Manage Departments</a>
                <a href="{% url 'system_settings' %}" class="btn btn-secondary">System Settings</a>
            </div>
        </div>
        {% endif %}

        {% if 'DAAA' in user_roles %}
        <div style="margin-bottom: 40px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 20px; font-size: 18px; font-weight: 600;">Academic Affairs</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <a href="{% url 'manage_sessions' %}" class="btn btn-primary">Manage Sessions</a>
                <a href="{% url 'approve_results' %}" class="btn btn-primary">Approve Results</a>
                <a href="{% url 'publish_results' %}" class="btn btn-primary">Publish Results</a>
            </div>
        </div>
        {% endif %}

        {% if 'FACULTY_DEAN' in user_roles %}
        <div style="margin-bottom: 24px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 12px;">Faculty Dean Actions</h3>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{% url 'faculty_dean_dashboard' %}" class="btn btn-primary">Faculty Dean Dashboard</a>
                <a href="{% url 'approve_results' %}" class="btn btn-primary">Approve Results</a>
                <a href="{% url 'manage_departments' %}" class="btn btn-secondary">Manage Departments</a>
            </div>
        </div>
        {% endif %}

        {% if 'HOD' in user_roles %}
        <div style="margin-bottom: 24px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 12px;">HOD Actions</h3>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{% url 'results' %}" class="btn btn-primary">Department Results</a>
                <a href="{% url 'approve_results' %}" class="btn btn-primary">Approve Results</a>
                <a href="{% url 'courses' %}" class="btn btn-secondary">Manage Courses</a>
            </div>
        </div>
        {% endif %}

        {% if 'EXAM_OFFICER' in user_roles %}
        <div style="margin-bottom: 24px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 12px;">Exam Officer Actions</h3>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{% url 'results' %}" class="btn btn-primary">Verify Results</a>
                <a href="{% url 'approve_results' %}" class="btn btn-primary">Approve Results</a>
            </div>
        </div>
        {% endif %}

        {% if 'LECTURER' in user_roles %}
        <div style="margin-bottom: 40px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 20px; font-size: 18px; font-weight: 600;">Teaching & Results</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <a href="{% url 'results' %}" class="btn btn-primary">Enter Results</a>
                <a href="{% url 'courses' %}" class="btn btn-secondary">My Courses</a>
                <a href="{% url 'students' %}" class="btn btn-secondary">My Students</a>
            </div>
        </div>
        {% endif %}

        {% if 'STUDENT' in user_roles %}
        <div style="margin-bottom: 24px;">
            <h3 style="color: var(--ios-blue); margin-bottom: 12px;">Student Actions</h3>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{% url 'results' %}" class="btn btn-primary">View Results</a>
                <a href="{% url 'courses' %}" class="btn btn-secondary">My Courses</a>
                <a href="{% url 'contact_admin' %}" class="btn btn-secondary">Profile</a>
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    <div class="ios-card">
        <h2 style="color: var(--text-primary); margin-bottom: 24px; font-size: 20px; font-weight: 600;">Your Roles</h2>
        {% if roles_with_details %}
            {% for role_info in roles_with_details %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 16px; background: var(--surface-secondary); border-radius: 12px; border: 1px solid var(--border-light);">
                <div>
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                        {% get_role_display_name role_info.role %}
                        {% if role_info.is_delegated %}
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 10px;">Delegated</span>
                        {% endif %}
                    </div>
                    {% if role_info.faculty %}
                        <div style="color: var(--text-secondary); font-size: 14px;">{{ role_info.faculty.name }}</div>
                    {% endif %}
                    {% if role_info.department %}
                        <div style="color: var(--text-secondary); font-size: 14px;">{{ role_info.department.name }}</div>
                    {% endif %}
                    {% if role_info.is_delegated and role_info.delegated_from %}
                        <div style="color: var(--text-tertiary); font-size: 12px;">Delegated from: {{ role_info.delegated_from.get_full_name }}</div>
                    {% endif %}
                </div>
                <div style="display: flex; gap: 8px;">
                    {% if not role_info.is_delegated and not role_info.is_temporary %}
                        <span style="background: var(--ios-blue); color: white; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">Primary</span>
                    {% endif %}
                    {% if role_info.is_temporary %}
                        <span style="background: var(--ios-orange); color: white; padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">Temporary</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p>No roles assigned</p>
            </div>
        {% endif %}
        </div>

        <div class="ios-card">
            <h2 style="color: var(--text-primary); margin-bottom: 20px;">Recent Activity</h2>
            {% if recent_activities %}
                {% for activity in recent_activities %}
                <div style="margin-bottom: 12px; padding: 12px; background: var(--tertiary-white); border-radius: 8px;">
                    <strong>{{ activity.action }}</strong>
                    <br><small style="color: var(--text-secondary);">{{ activity.description }}</small>
                    <br><small style="color: var(--text-secondary);">{{ activity.timestamp|timesince }} ago</small>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No recent activity</p>
            {% endif %}
        </div>
    </div>
</div>

{% else %}
<!-- No roles assigned -->
<div class="ios-card" style="text-align: center; padding: 40px;">
    <h2 style="color: var(--text-secondary); margin-bottom: 16px;">No Roles Assigned</h2>
    <p style="color: var(--text-secondary); margin-bottom: 24px;">Contact your administrator to assign appropriate roles to your account.</p>
    <a href="{% url 'contact_admin' %}" class="btn btn-primary">Contact Administrator</a>
</div>
{% endif %}


{% endblock %}
