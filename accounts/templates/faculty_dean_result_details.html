{% extends 'base.html' %}
{% load role_tags %}

{% block title %}Result Details - {{ faculty.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Delegation Status Badges -->
    {% show_delegation_badges user %}
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: var(--royal-blue-gradient); color: white;">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-1 fw-bold">Result Details</h1>
                            <p class="mb-0 opacity-75">{{ result.enrollment.student.matric_number }} - {{ result.enrollment.course.code }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{% url 'faculty_dean_pending_results' %}" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-left me-1"></i>Back to Pending Results
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Student Information -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        <i class="bi bi-person-circle me-2"></i>Student Information
                    </h5>
                    <div class="row">
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Full Name</label>
                            <div class="fw-bold">{{ result.enrollment.student.user.get_full_name }}</div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Matric Number</label>
                            <div class="fw-bold">{{ result.enrollment.student.matric_number }}</div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Department</label>
                            <div class="fw-bold">{{ result.enrollment.student.department.name }}</div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Level</label>
                            <div class="fw-bold">{{ result.enrollment.student.level.name }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Information -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        <i class="bi bi-book me-2"></i>Course Information
                    </h5>
                    <div class="row">
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Course Code</label>
                            <div class="fw-bold">{{ result.enrollment.course.code }}</div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Credit Units</label>
                            <div class="fw-bold">{{ result.enrollment.course.credit_units }}</div>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label text-muted small">Course Title</label>
                            <div class="fw-bold">{{ result.enrollment.course.title }}</div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Academic Session</label>
                            <div class="fw-bold">{{ result.enrollment.session.name }}</div>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted small">Lecturer</label>
                            <div class="fw-bold">{{ result.created_by.get_full_name }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Score Details -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        <i class="bi bi-calculator me-2"></i>Score Breakdown
                    </h5>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <div class="h4 fw-bold text-primary">{{ result.ca_score|floatformat:1 }}</div>
                                <small class="text-muted">CA Score</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <div class="h4 fw-bold text-info">{{ result.exam_score|floatformat:1 }}</div>
                                <small class="text-muted">Exam Score</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-success text-white rounded">
                                <div class="h4 fw-bold">{{ result.total_score|floatformat:1 }}</div>
                                <small>Total Score</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <span class="badge bg-success fs-6 px-3 py-2">Grade: {{ result.grade }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Information -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        <i class="bi bi-info-circle me-2"></i>Status Information
                    </h5>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Current Status</label>
                        <div>
                            {% if result.status == 'SUBMITTED_TO_DEAN' %}
                                <span class="badge bg-warning fs-6">{{ result.get_status_display }}</span>
                            {% elif result.status == 'APPROVED_BY_DEAN' %}
                                <span class="badge bg-success fs-6">{{ result.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-info fs-6">{{ result.get_status_display }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Submitted On</label>
                        <div class="fw-bold">{{ result.created_at|date:"F d, Y g:i A" }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Last Updated</label>
                        <div class="fw-bold">{{ result.updated_at|date:"F d, Y g:i A" }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval History -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        <i class="bi bi-clock-history me-2"></i>Approval History
                    </h5>
                    {% if approval_history %}
                        <div class="timeline">
                            {% for history in approval_history %}
                            <div class="timeline-item mb-3">
                                <div class="row">
                                    <div class="col-md-2 text-center">
                                        <div class="timeline-marker">
                                            {% if history.action == 'APPROVED' %}
                                                <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                            {% elif history.action == 'REJECTED' %}
                                                <i class="bi bi-x-circle-fill text-danger fs-4"></i>
                                            {% elif history.action == 'AUTO_PROGRESSED' %}
                                                <i class="bi bi-arrow-right-circle-fill text-info fs-4"></i>
                                            {% else %}
                                                <i class="bi bi-circle-fill text-secondary fs-4"></i>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ history.timestamp|date:"M d, Y" }}<br>{{ history.timestamp|time:"g:i A" }}</small>
                                    </div>
                                    <div class="col-md-10">
                                        <div class="card bg-light border-0">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="mb-1 fw-bold">
                                                            {{ history.get_action_display }} by {{ history.actor_role|title }}
                                                        </h6>
                                                        <p class="mb-1 text-muted small">
                                                            {{ history.actor.get_full_name }} ({{ history.actor.username }})
                                                        </p>
                                                        <p class="mb-1 small">
                                                            <strong>Status:</strong> {{ history.from_status }} → {{ history.to_status }}
                                                        </p>
                                                        {% if history.comments %}
                                                        <p class="mb-0 small">
                                                            <strong>Comments:</strong> {{ history.comments }}
                                                        </p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-clock-history" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-2">No approval history available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    {% if result.status == 'SUBMITTED_TO_DEAN' %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-primary mb-3">
                        <i class="bi bi-gear me-2"></i>Actions
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-warning" onclick="editScore({{ result.id }}, {{ result.ca_score }}, {{ result.exam_score }})">
                            <i class="bi bi-pencil-square me-1"></i>Edit Score
                        </button>
                        <button type="button" class="btn btn-success" onclick="approveResult({{ result.id }}, '{{ result.enrollment.student.matric_number }}')">
                            <i class="bi bi-check-circle me-1"></i>Approve Result
                        </button>
                        <button type="button" class="btn btn-danger" onclick="rejectResult({{ result.id }}, '{{ result.enrollment.student.matric_number }}')">
                            <i class="bi bi-x-circle me-1"></i>Reject Result
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'faculty_dean_pending_results' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="result_id" id="approvalResultId">
                    <input type="hidden" name="action" value="approve">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        You are about to approve the result for student <strong id="approvalStudentId"></strong>.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comments (Optional)</label>
                        <textarea name="comments" class="form-control" rows="3" placeholder="Add any comments about this approval..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i>Approve Result
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'faculty_dean_pending_results' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="result_id" id="rejectionResultId">
                    <input type="hidden" name="action" value="reject">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        You are about to reject the result for student <strong id="rejectionStudentId"></strong>.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea name="comments" class="form-control" rows="3" placeholder="Please provide a reason for rejecting this result..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle me-1"></i>Reject Result
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Score Modal -->
<div class="modal fade" id="editScoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Student Score</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'faculty_dean_edit_score' result.id %}" id="editScoreForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> Editing scores will automatically recalculate the total score and grade.
                        If the student is on the carry-over list and the new score meets the passing threshold,
                        they will be automatically removed from the carry-over list.
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CA Score <span class="text-danger">*</span></label>
                            <input type="number" name="ca_score" id="editCaScore" class="form-control"
                                   min="0" max="100" step="0.1" required>
                            <div class="form-text">Enter score between 0 and 100</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Exam Score <span class="text-danger">*</span></label>
                            <input type="number" name="exam_score" id="editExamScore" class="form-control"
                                   min="0" max="100" step="0.1" required>
                            <div class="form-text">Enter score between 0 and 100</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Total Score (Calculated)</label>
                        <input type="text" id="calculatedTotal" class="form-control" readonly>
                        <div class="form-text">This will be automatically calculated</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reason for Edit <span class="text-danger">*</span></label>
                        <textarea name="edit_reason" class="form-control" rows="3"
                                  placeholder="Please provide a reason for editing this score..." required></textarea>
                        <div class="form-text">This reason will be logged in the audit trail</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" id="editScoreSubmitBtn">
                        <i class="bi bi-pencil-square me-1"></i>Update Score
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function approveResult(resultId, studentId) {
    document.getElementById('approvalResultId').value = resultId;
    document.getElementById('approvalStudentId').textContent = studentId;
    new bootstrap.Modal(document.getElementById('approvalModal')).show();
}

function rejectResult(resultId, studentId) {
    document.getElementById('rejectionResultId').value = resultId;
    document.getElementById('rejectionStudentId').textContent = studentId;
    new bootstrap.Modal(document.getElementById('rejectionModal')).show();
}

function editScore(resultId, currentCaScore, currentExamScore) {
    console.log('editScore called with:', resultId, currentCaScore, currentExamScore);

    // Set current values in the form
    document.getElementById('editCaScore').value = currentCaScore;
    document.getElementById('editExamScore').value = currentExamScore;

    // Calculate and display current total
    updateCalculatedTotal();

    // Reset submit button state
    const submitBtn = document.getElementById('editScoreSubmitBtn');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Update Score';
    }

    new bootstrap.Modal(document.getElementById('editScoreModal')).show();
}

function updateCalculatedTotal() {
    const caScore = parseFloat(document.getElementById('editCaScore').value) || 0;
    const examScore = parseFloat(document.getElementById('editExamScore').value) || 0;
    const total = caScore + examScore;

    document.getElementById('calculatedTotal').value = total.toFixed(1);

    // Add visual feedback for score ranges
    const totalField = document.getElementById('calculatedTotal');
    totalField.className = 'form-control';

    if (total >= 70) {
        totalField.classList.add('border-success');
    } else if (total >= 40) {
        totalField.classList.add('border-warning');
    } else {
        totalField.classList.add('border-danger');
    }
}

// Add event listeners for real-time total calculation
document.addEventListener('DOMContentLoaded', function() {
    const caScoreInput = document.getElementById('editCaScore');
    const examScoreInput = document.getElementById('editExamScore');

    if (caScoreInput && examScoreInput) {
        caScoreInput.addEventListener('input', updateCalculatedTotal);
        examScoreInput.addEventListener('input', updateCalculatedTotal);
    }

    // Form validation and submission handling
    const editScoreForm = document.getElementById('editScoreForm');
    if (editScoreForm) {
        editScoreForm.addEventListener('submit', function(e) {
            const caScore = parseFloat(document.getElementById('editCaScore').value);
            const examScore = parseFloat(document.getElementById('editExamScore').value);
            const reason = document.querySelector('textarea[name="edit_reason"]').value.trim();

            // Validate scores
            if (isNaN(caScore) || caScore < 0 || caScore > 100) {
                e.preventDefault();
                alert('Please enter a valid CA score between 0 and 100.');
                return false;
            }

            if (isNaN(examScore) || examScore < 0 || examScore > 100) {
                e.preventDefault();
                alert('Please enter a valid Exam score between 0 and 100.');
                return false;
            }

            if (!reason) {
                e.preventDefault();
                alert('Please provide a reason for editing the score.');
                return false;
            }

            // Confirm the action
            const total = caScore + examScore;
            const confirmMessage = `Are you sure you want to update the score?\n\n` +
                                 `CA Score: ${caScore}\n` +
                                 `Exam Score: ${examScore}\n` +
                                 `Total Score: ${total.toFixed(1)}\n\n` +
                                 `This action will be logged in the audit trail.`;

            if (!confirm(confirmMessage)) {
                e.preventDefault();
                return false;
            }

            // Disable submit button to prevent double submission
            const submitBtn = document.getElementById('editScoreSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Updating...';
            }
        });
    }
});
</script>

<style>
.timeline-item {
    position: relative;
}

.timeline-marker {
    position: relative;
    z-index: 1;
}

.card {
    border-radius: 12px;
}

.btn {
    border-radius: 8px;
}

.badge {
    border-radius: 6px;
}
</style>
{% endblock %}
