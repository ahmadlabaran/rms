{% extends 'base.html' %}

{% block title %}Manage Courses - HOD{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Use Bootstrap styling to match other pages -->
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: var(--royal-blue-gradient);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h1 class="h3 mb-1 fw-bold">Manage Courses</h1>
                            <p class="mb-0 opacity-75">{{ department.name }} Department • {{ current_session.name|default:"No Active Session" }}</p>
                        </div>
                        <div>
                            <a href="{% url 'hod_dashboard' %}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100" style="background: var(--royal-blue-gradient);">
                <div class="card-body text-center text-white">
                    <div class="display-4 fw-bold mb-2">{{ stats.total_courses|default:0 }}</div>
                    <h6 class="text-white-50 text-uppercase mb-0">Total Courses</h6>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 bg-success">
                <div class="card-body text-center text-white">
                    <div class="display-4 fw-bold mb-2">{{ stats.assigned_courses|default:0 }}</div>
                    <h6 class="text-white-50 text-uppercase mb-0">Assigned</h6>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 bg-warning">
                <div class="card-body text-center text-white">
                    <div class="display-4 fw-bold mb-2">{{ stats.unassigned_courses|default:0 }}</div>
                    <h6 class="text-white-50 text-uppercase mb-0">Unassigned</h6>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 bg-info">
                <div class="card-body text-center text-white">
                    <div class="display-4 fw-bold mb-2">{{ stats.total_credit_units|default:0 }}</div>
                    <h6 class="text-white-50 text-uppercase mb-0">Total Credits</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Courses by Level -->
    {% for level_name, level_courses in courses_by_level.items %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-bold">{{ level_name }} Level Courses ({{ level_courses|length }})</h5>
                </div>
                <div class="card-body p-0">
                    {% for course in level_courses %}
                    <div class="border-bottom p-4 {% if course.assigned_lecturer %}bg-light{% endif %}">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <h6 class="mb-0 fw-bold">{{ course.code }} - {{ course.title }}</h6>
                                    {% if course.assigned_lecturer %}
                                        <span class="badge bg-success">Assigned</span>
                                    {% else %}
                                        <span class="badge bg-warning">Unassigned</span>
                                    {% endif %}
                                </div>

                                <div class="text-muted small mb-1">
                                    <i class="fas fa-credit-card me-1"></i>
                                    <strong>Credits:</strong> {{ course.credit_units }} • <strong>Session:</strong> {{ course.session.name }}
                                </div>

                                {% if course.assigned_lecturer %}
                                    <div class="text-success small fw-bold">
                                        <i class="fas fa-user me-1"></i>Lecturer: {{ course.assigned_lecturer.get_full_name }}
                                    </div>
                                {% else %}
                                    <div class="text-warning small fw-bold">
                                        <i class="fas fa-exclamation-triangle me-1"></i>No lecturer assigned
                                    </div>
                                {% endif %}
                            </div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-outline-primary btn-sm course-action" data-action="view" data-course-id="{{ course.id }}" data-course-code="{{ course.code }}">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                {% if not course.assigned_lecturer %}
                                    <button class="btn btn-success btn-sm course-action" data-action="assign" data-course-id="{{ course.id }}" data-course-code="{{ course.code }}">
                                        <i class="fas fa-user-plus me-1"></i>Assign
                                    </button>
                                {% else %}
                                    <button class="btn btn-warning btn-sm course-action" data-action="change" data-course-id="{{ course.id }}" data-course-code="{{ course.code }}">
                                        <i class="fas fa-user-edit me-1"></i>Change
                                    </button>
                                {% endif %}
                                <button class="btn btn-primary btn-sm course-action" data-action="edit" data-course-id="{{ course.id }}" data-course-code="{{ course.code }}">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-book fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Courses Found</h4>
                    <p class="text-muted mb-4">No courses have been created for {{ current_session.name|default:"the current session" }}.</p>
                    <a href="{% url 'hod_create_course' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Create Your First Course
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 fw-bold">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <a href="{% url 'hod_create_course' %}" class="btn btn-primary w-100">
                                <i class="fas fa-plus me-1"></i>Create New Course
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{% url 'hod_assign_lecturers' %}" class="btn btn-success w-100">
                                <i class="fas fa-user-plus me-1"></i>Assign Lecturers
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button onclick="exportCourses()" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-download me-1"></i>Export Course List
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button onclick="importCourses()" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-upload me-1"></i>Import Courses
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function viewCourseDetails(courseId, courseCode) {
    // Get course details from the current page data
    const courseElement = document.querySelector(`[data-course-id="${courseId}"]`);
    const courseContainer = courseElement.closest('.border-bottom');
    const courseTitle = courseContainer.querySelector('.fw-bold').textContent.split(' - ')[1];
    const courseDesc = courseContainer.querySelector('.text-muted').textContent;
    const creditUnits = courseContainer.querySelector('.text-muted').textContent.match(/(\d+) units/)[1];

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 1000;
    `;
    modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 16px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">Course Details: ${courseCode}</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                <strong>${courseTitle}</strong><br>
                Credit Units: ${creditUnits}<br>
                ${courseDesc}
            </p>
            <button onclick="closeModal(this)"
                    style="background: var(--ios-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; float: right;">
                Close
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

function assignLecturer(courseId, courseCode) {
    // Fetch available lecturers from API
    fetch('/api/hod/api/lecturers/')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            showLecturerAssignmentModal(courseId, courseCode, data.lecturers);
        })
        .catch(error => {
            console.error('Error fetching lecturers:', error);
            alert('Error loading lecturers. Please try again.');
        });
}

function showLecturerAssignmentModal(courseId, courseCode, lecturers) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 1000;
    `;

    let lecturerOptions = '<option value="">Select a lecturer...</option>';
    lecturers.forEach(lecturer => {
        lecturerOptions += `<option value="${lecturer.id}">${lecturer.name}</option>`;
    });

    modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 16px; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">Assign Lecturer to ${courseCode}</h3>
            <form id="assignLecturerForm">
                <select id="lecturerSelect" style="width: 100%; padding: 8px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px;" required>
                    ${lecturerOptions}
                </select>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal(this)"
                            style="background: #f0f0f0; color: #333; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="submit"
                            style="background: var(--ios-green); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                        Assign
                    </button>
                </div>
            </form>
        </div>
    `;

    document.body.appendChild(modal);

    // Handle form submission
    document.getElementById('assignLecturerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const lecturerId = document.getElementById('lecturerSelect').value;
        if (!lecturerId) {
            alert('Please select a lecturer');
            return;
        }

        assignCourseToLecturer(courseId, lecturerId, modal);
    });
}

function assignCourseToLecturer(courseId, lecturerId, modal) {
    const formData = new FormData();
    formData.append('lecturer_id', lecturerId);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/api/hod/api/course/${courseId}/assign/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            modal.remove();
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error assigning lecturer:', error);
        alert('Error assigning lecturer. Please try again.');
    });
}

function changeLecturer(courseId, courseCode) {
    assignLecturer(courseId, courseCode); // Reuse the same modal
}

function editCourse(courseId, courseCode) {
    // Get current course data from the page
    const courseElement = document.querySelector(`[data-course-id="${courseId}"]`);
    const courseContainer = courseElement.closest('.border-bottom');
    const currentTitle = courseContainer.querySelector('.fw-bold').textContent.split(' - ')[1];
    const currentCode = courseContainer.querySelector('.fw-bold').textContent.split(' - ')[0];
    const currentCreditUnits = courseContainer.querySelector('.text-muted').textContent.match(/(\d+) units/)[1];

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 1000;
    `;

    modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 16px; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">Edit Course: ${courseCode}</h3>
            <form id="editCourseForm">
                <input type="text" id="courseTitle" value="${currentTitle}" placeholder="Course Title"
                       style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px;" required>
                <input type="text" id="courseCode" value="${currentCode}" placeholder="Course Code"
                       style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; text-transform: uppercase;" required>
                <select id="creditUnits" style="width: 100%; padding: 8px; margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px;" required>
                    <option value="1" ${currentCreditUnits == '1' ? 'selected' : ''}>1</option>
                    <option value="2" ${currentCreditUnits == '2' ? 'selected' : ''}>2</option>
                    <option value="3" ${currentCreditUnits == '3' ? 'selected' : ''}>3</option>
                    <option value="4" ${currentCreditUnits == '4' ? 'selected' : ''}>4</option>
                    <option value="5" ${currentCreditUnits == '5' ? 'selected' : ''}>5</option>
                    <option value="6" ${currentCreditUnits == '6' ? 'selected' : ''}>6</option>
                </select>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal(this)"
                            style="background: #f0f0f0; color: #333; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="submit"
                            style="background: var(--ios-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                        Update
                    </button>
                </div>
            </form>
        </div>
    `;

    document.body.appendChild(modal);

    // Handle form submission
    document.getElementById('editCourseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateCourse(courseId, modal);
    });
}

function updateCourse(courseId, modal) {
    const formData = new FormData();
    formData.append('title', document.getElementById('courseTitle').value);
    formData.append('code', document.getElementById('courseCode').value);
    formData.append('credit_units', document.getElementById('creditUnits').value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/api/hod/api/course/${courseId}/edit/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            modal.remove();
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error updating course:', error);
        alert('Error updating course. Please try again.');
    });
}

// Helper function to close modals properly
function closeModal(element) {
    const modal = element.closest('.modal-overlay') || element.closest('[style*="position: fixed"]');
    if (modal) {
        modal.remove();
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.remove();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-overlay, [style*="position: fixed"]');
        modals.forEach(modal => modal.remove());
    }
});

function exportCourses() {
    // Simulate export functionality
    const link = document.createElement('a');
    link.href = 'data:text/csv;charset=utf-8,Course Code,Course Title,Credit Units,Level\nCSC101,Introduction to Computer Science,3,100\nCSC201,Data Structures,4,200';
    link.download = 'courses_export.csv';
    link.click();
    alert('Courses exported successfully!');
}

function importCourses() {
    // Show import modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 1000;
    `;
    modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 16px; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">Import Courses</h3>
            <input type="file" accept=".csv,.xlsx" style="width: 100%; margin-bottom: 16px; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">
                Upload a CSV or Excel file with columns: Course Code, Course Title, Credit Units, Level
            </p>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button onclick="this.closest('div').parentElement.remove()"
                        style="background: #f0f0f0; color: #333; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="alert('Courses imported successfully!'); this.closest('div').parentElement.remove();"
                        style="background: var(--ios-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    Import
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Handle course action buttons with data attributes
document.addEventListener('DOMContentLoaded', function() {
    // Handle course action buttons
    const courseActionButtons = document.querySelectorAll('.course-action');
    courseActionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            const courseId = this.getAttribute('data-course-id');
            const courseCode = this.getAttribute('data-course-code');

            switch(action) {
                case 'view':
                    viewCourseDetails(courseId, courseCode);
                    break;
                case 'assign':
                    assignLecturer(courseId, courseCode);
                    break;
                case 'change':
                    changeLecturer(courseId, courseCode);
                    break;
                case 'edit':
                    editCourse(courseId, courseCode);
                    break;
            }
        });
    });

    // Handle navigation buttons
    const navButtons = document.querySelectorAll('.nav-button');
    navButtons.forEach(button => {
        button.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            if (url) {
                window.location.href = url;
            }
        });
    });
});
</script>
{% endblock %}
