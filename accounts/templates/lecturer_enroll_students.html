{% extends 'base.html' %} {% load role_tags %} {% block title %}Enroll Students - Lecturer{% endblock %} {% block content %} <div class="container-fluid"> <!-- Delegation Status Badges --> {% show_delegation_badges user %} <!-- Header --> <div class="row mb-4"> <div class="col-12"> <div class="card" style="background: var(--royal-blue-gradient); color: white;"> <div class="card-body"> <h1 class="mb-1 fw-bold">Enroll Students</h1> <p class="mb-0 opacity-75">Add students to your courses</p> </div> </div> </div> </div> <!-- Enrollment Form --> <div class="row"> <div class="col-12"> <div class="card"> <div class="card-header d-flex justify-content-between align-items-center"> <h5 class="mb-0 fw-bold">Student Enrollment</h5> <a href="{% url 'lecturer_dashboard' %}" class="btn btn-outline-secondary btn-sm"> <i class="bi bi-arrow-left me-1"></i>Back to Dashboard </a> </div> <div class="card-body"> <form method="post" id="enrollmentForm"> {% csrf_token %} <div class="row mb-4"> <div class="col-md-6"> <label class="form-label fw-bold">Select Course</label> <select name="course_id" class="form-select" required id="courseSelect"> <option value="">Choose a course...</option> {% for assignment in assigned_courses %} <option value="{{ assignment.course.id }}" data-level="{{ assignment.course.level.name }}"> {{ assignment.course.code }} - {{ assignment.course.title }} {% if 'general' in assignment.course.code|lower or 'gst' in assignment.course.code|lower or 'gns' in assignment.course.code|lower or 'general studies' in assignment.course.title|lower %} <small>(University-wide enrollment)</small> {% else %} <small>(Faculty-wide enrollment)</small> {% endif %} </option> {% endfor %} </select> <small class="text-muted">Students from any department/level can be enrolled</small> </div> <div class="col-md-6"> <label class="form-label fw-bold">Academic Session</label> <select name="session_id" class="form-select" required> <option value="">Select session...</option> {% for session in sessions %} <option value="{{ session.id }}" {% if session.is_active %}selected{% endif %}> {{ session.name }} </option> {% endfor %} </select> </div> </div> <!-- Student Search and Selection --> <div class="mb-4"> <label class="form-label fw-bold">Search and Select Students</label> <div class="alert alert-info py-2 mb-3" id="enrollmentNote"> <small><i class="bi bi-info-circle me-1"></i> <strong>Note:</strong> You can enroll students from any department and level within your faculty. The course is not restricted to specific departments or levels. </small> </div> <div class="card"> <div class="card-header"> <div class="row"> <div class="col-md-6"> <input type="text" class="form-control" placeholder="Type at least 3 characters to search students..." id="studentSearch" disabled> <small class="text-muted">Select a course first to enable search (minimum 3 characters)</small> </div> <div class="col-md-3"> <select class="form-select" id="levelFilter" disabled> <option value="">All Levels</option> <option value="100">100 Level</option> <option value="200">200 Level</option> <option value="300">300 Level</option> <option value="400">400 Level</option> </select> <small class="text-muted">Filter by level</small> </div> <div class="col-md-3 text-end"> <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="browseAllStudents()" id="browseBtn" disabled> <i class="bi bi-list me-1"></i>Browse All </button> <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelected()"> <i class="bi bi-x-circle me-1"></i>Clear Selected </button> </div> </div> </div> <div class="card-body"> <!-- Search Results --> <div id="searchResults" class="mb-3" style="display: none;"> <h6 class="text-muted">Search Results:</h6> <div id="searchResultsContainer"></div> </div> <!-- Selected Students --> <div id="selectedStudents"> <h6 class="text-muted">Selected Students: <span id="selectedCount">0</span></h6> <div id="selectedStudentsContainer"> <div class="text-center py-4 text-muted"> <i class="bi bi-people display-4"></i> <p class="mt-2">No students selected yet. Search and click to add students.</p> </div> </div> </div> </div> </div> </div> <!-- Action Buttons --> <div class="d-flex gap-2 justify-content-end"> <a href="{% url 'lecturer_dashboard' %}" class="btn btn-secondary">Cancel</a> <button type="submit" class="btn btn-primary"> <i class="bi bi-person-plus me-1"></i>Enroll Selected Students </button> </div> </form> </div> </div> </div> </div> </div> <script> let selectedStudents = []; let searchTimeout; document.addEventListener('DOMContentLoaded', function() { const studentSearch = document.getElementById('studentSearch'); const courseSelect = document.getElementById('courseSelect'); const enrollmentForm = document.getElementById('enrollmentForm'); // Course selection handler courseSelect.addEventListener('change', function() { if (this.value) { const selectedOption = this.options[this.selectedIndex]; const courseCode = selectedOption.textContent.split(' - ')[0]; const courseTitle = selectedOption.textContent.toLowerCase(); // Check if this is a General Studies course const isGeneralStudies = ( courseCode.toLowerCase().includes('gst') || courseCode.toLowerCase().includes('gns') || courseCode.toLowerCase().includes('general') || courseTitle.includes('general studies') ); studentSearch.disabled = false; if (isGeneralStudies) { studentSearch.placeholder = 'Type 3+ characters to search ALL UNIVERSITY STUDENTS...'; studentSearch.nextElementSibling.textContent = 'General Studies: Search ALL students from any faculty, department, or level (min 3 chars)'; // Update the note for General Studies const note = document.getElementById('enrollmentNote'); note.className = 'alert alert-success py-2 mb-3'; note.innerHTML = ` <small><i class="bi bi-globe me-1"></i> <strong>General Studies Course:</strong> Search across the entire university - all faculties, departments, and levels. All matching students will be shown (no limits). </small> `; } else { studentSearch.placeholder = 'Type 3+ characters to search ALL FACULTY STUDENTS...'; studentSearch.nextElementSibling.textContent = 'Faculty Course: Search ALL students in your faculty - any department or level (min 3 chars)'; // Reset the note for regular courses const note = document.getElementById('enrollmentNote'); note.className = 'alert alert-info py-2 mb-3'; note.innerHTML = ` <small><i class="bi bi-info-circle me-1"></i> <strong>Faculty Course:</strong> Search across your entire faculty - all departments and levels. All matching students will be shown (no limits). </small> `; } // Enable filter and browse controls document.getElementById('levelFilter').disabled = false; document.getElementById('browseBtn').disabled = false; clearSelected(); } else { studentSearch.disabled = true; document.getElementById('levelFilter').disabled = true; document.getElementById('browseBtn').disabled = true; studentSearch.placeholder = 'Search by matric number or name...'; studentSearch.nextElementSibling.textContent = 'Select a course first to enable search'; clearSelected(); } }); // Level filter handler document.getElementById('levelFilter').addEventListener('change', function() { const query = document.getElementById('studentSearch').value.trim(); const courseId = courseSelect.value; if (query.length >= 3 && courseId) { clearTimeout(searchTimeout); searchTimeout = => { searchStudents(query, courseId); }, 300); } }); // Search functionality with optimized debouncing studentSearch.addEventListener('input', function() { const query = this.value.trim(); const courseId = courseSelect.value; clearTimeout(searchTimeout); if (query.length >= 3 && courseId) { // Increased minimum length to 3 for better performance searchTimeout = => { searchStudents(query, courseId); }, 400); // Slightly longer delay for better performance } else if (query.length < 3) { hideSearchResults(); } }); // Form validation enrollmentForm.addEventListener('submit', function(e) { if (selectedStudents.length === 0) { e.preventDefault(); alert('Please select at least one student to enroll.'); return; } if (!confirm(`Enroll ${selectedStudents.length} student(s) in the selected course?`)) { e.preventDefault(); } }); }); function searchStudents(query, courseId) { const levelFilter = document.getElementById('levelFilter').value; let url = `/api/lecturer/enroll-students/?search=${encodeURIComponent(query)}&course_id=${courseId}`; if (levelFilter) { url += `&level=${levelFilter}`; } fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } }) .then(response => response.json()) .then(data => { if (data.students) { displaySearchResults(data.students); } else { hideSearchResults(); } }) .catch(error => { console.error('Search error:', error); hideSearchResults(); }); } function displaySearchResults(students) { const searchResults = document.getElementById('searchResults'); const container = document.getElementById('searchResultsContainer'); if (students.length === 0) { container.innerHTML = '<p class="text-muted">No students found matching your search.</p>'; } else { let html = ''; students.forEach(student => { const isSelected = selectedStudents.some(s => s.id === student.id); html += ` <div class="card mb-2 ${isSelected ? 'border-success' : ''}"> <div class="card-body py-2"> <div class="d-flex justify-content-between align-items-center"> <div> <strong class="text-primary">${student.matric_number}</strong> - ${student.name} <br><small class="text-muted"> <span class="badge bg-info me-1">${student.level}</span> <span class="badge bg-secondary me-1">${student.department}</span> ${student.is_general_studies && student.faculty ? `<span class="badge bg-warning">${student.faculty}</span>` : ''} </small> </div> <button type="button" class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-primary'}" onclick="toggleStudent(${student.id}, '${student.matric_number}', '${student.name}', '${student.level}', '${student.department}', '${student.faculty || ''}')" ${isSelected ? 'disabled' : ''}> ${isSelected ? 'Selected' : 'Select'} </button> </div> </div> </div> `; }); container.innerHTML = html; } searchResults.style.display = 'block'; } function hideSearchResults() { document.getElementById('searchResults').style.display = 'none'; } function toggleStudent(id, matricNumber, name, level, department, faculty = '') { const student = { id, matricNumber, name, level, department, faculty }; // Check if already selected const existingIndex = selectedStudents.findIndex(s => s.id === id); if (existingIndex === -1) { selectedStudents.push(student); updateSelectedStudentsDisplay(); updateSearchResults(); } } function removeStudent(id) { selectedStudents = selectedStudents.filter(s => s.id !== id); updateSelectedStudentsDisplay(); updateSearchResults(); } function updateSelectedStudentsDisplay() { const container = document.getElementById('selectedStudentsContainer'); const countSpan = document.getElementById('selectedCount'); countSpan.textContent = selectedStudents.length; if (selectedStudents.length === 0) { container.innerHTML = ` <div class="text-center py-4 text-muted"> <i class="bi bi-people display-4"></i> <p class="mt-2">No students selected yet. Search and click to add students.</p> </div> `; } else { let html = ''; selectedStudents.forEach(student => { html += ` <div class="card mb-2 border-success"> <div class="card-body py-2"> <div class="d-flex justify-content-between align-items-center"> <div> <strong class="text-primary">${student.matricNumber}</strong> - ${student.name} <br><small class="text-muted"> <span class="badge bg-info me-1">${student.level}</span> <span class="badge bg-secondary me-1">${student.department}</span> ${student.faculty ? `<span class="badge bg-warning">${student.faculty}</span>` : ''} </small> <input type="hidden" name="student_ids" value="${student.id}"> </div> <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeStudent(${student.id})"> <i class="bi bi-x"></i> Remove </button> </div> </div> </div> `; }); container.innerHTML = html; } } function updateSearchResults() { // Refresh search results to update button states const query = document.getElementById('studentSearch').value.trim(); const courseId = document.getElementById('courseSelect').value; if (query.length >= 2 && courseId) { searchStudents(query, courseId); } } function browseAllStudents() { const courseId = document.getElementById('courseSelect').value; if (!courseId) { alert('Please select a course first.'); return; } // Use a special search query to get all students fetch(`/api/lecturer/enroll-students/?browse=all&course_id=${courseId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } }) .then(response => response.json()) .then(data => { if (data.students) { displaySearchResults(data.students); document.getElementById('searchResults').style.display = 'block'; document.getElementById('searchResultsContainer').scrollIntoView({ behavior: 'smooth' }); } else { alert('No students found.'); } }) .catch(error => { console.error('Browse error:', error); alert('Error browsing students. Please try again.'); }); } function browseStudentsByLevel(level) { const courseId = document.getElementById('courseSelect').value; if (!courseId) { alert('Please select a course first.'); return; } // Set the level filter and browse document.getElementById('levelFilter').value = level; fetch(`/api/lecturer/enroll-students/?browse=all&course_id=${courseId}&level=${level}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } }) .then(response => response.json()) .then(data => { if (data.students) { displaySearchResults(data.students); document.getElementById('searchResults').style.display = 'block'; document.getElementById('searchResultsContainer').scrollIntoView({ behavior: 'smooth' }); } else { alert(`No ${level} level students found.`); } }) .catch(error => { console.error('Browse error:', error); alert('Error browsing students. Please try again.'); }); } function clearSelected() { selectedStudents = []; updateSelectedStudentsDisplay(); hideSearchResults(); document.getElementById('studentSearch').value = ''; document.getElementById('levelFilter').value = ''; } </script> {% endblock %} 