{% extends 'base.html' %}
{% load role_tags %}

{% block title %}Enter Results - Lecturer{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Delegation Status Badges -->
    {% show_delegation_badges user %}

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: var(--royal-blue-gradient); color: white;">
                <div class="card-body">
                    <h1 class="mb-1 fw-bold">Enter Results</h1>
                    <p class="mb-0 opacity-75">Input student results for your courses</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">Select Course</h5>
                    <a href="{% url 'lecturer_dashboard' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
                <div class="card-body">
                    <form method="get" id="courseSelectionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Course</label>
                                <select name="course_id" class="form-select" required onchange="this.form.submit()">
                                    <option value="">Choose a course...</option>
                                    {% for assignment in assigned_courses %}
                                    <option value="{{ assignment.course.id }}" 
                                            {% if selected_course and selected_course.id == assignment.course.id %}selected{% endif %}>
                                        {{ assignment.course.code }} - {{ assignment.course.title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Academic Session</label>
                                <select name="session_id" class="form-select" required onchange="this.form.submit()">
                                    <option value="">Select session...</option>
                                    {% for session in sessions %}
                                    <option value="{{ session.id }}" 
                                            {% if selected_session and selected_session.id == session.id %}selected{% endif %}
                                            {% if session.is_active and not selected_session %}selected{% endif %}>
                                        {{ session.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Entry Form -->
    {% if selected_course and enrolled_students %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 fw-bold">{{ selected_course.code }} - {{ selected_course.title }}</h5>
                            <small class="text-muted">{{ enrolled_students.count }} students enrolled</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="calculateTotals()">
                                <i class="bi bi-calculator me-1"></i>Calculate All
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="saveDraft()">
                                <i class="bi bi-save me-1"></i>Save as Draft
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="resultsForm">
                        {% csrf_token %}
                        <input type="hidden" name="course_id" value="{{ selected_course.id }}">
                        <input type="hidden" name="session_id" value="{{ selected_session.id }}">
                        
                        <!-- Desktop Table View -->
                        <div class="d-none d-lg-block">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Matric Number</th>
                                            <th>Student Name</th>
                                            <th>CA Score (30)</th>
                                            <th>Exam Score (70)</th>
                                            <th>Total (100)</th>
                                            <th>Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for enrollment in enrolled_students %}
                                        <tr>
                                            <td>
                                                <span class="fw-bold text-primary">{{ enrollment.student.matric_number }}</span>
                                            </td>
                                            <td>{{ enrollment.student.get_full_name }}</td>
                                            <td>
                                                <input type="number" name="ca_score_{{ enrollment.id }}" 
                                                       class="form-control form-control-sm ca-score" 
                                                       min="0" max="30" step="0.01"
                                                       value="{{ enrollment.result.ca_score|default:'' }}"
                                                       onchange="calculateTotal({{ enrollment.id }})">
                                            </td>
                                            <td>
                                                <input type="number" name="exam_score_{{ enrollment.id }}" 
                                                       class="form-control form-control-sm exam-score" 
                                                       min="0" max="70" step="0.01"
                                                       value="{{ enrollment.result.exam_score|default:'' }}"
                                                       onchange="calculateTotal({{ enrollment.id }})">
                                            </td>
                                            <td>
                                                <input type="number" name="total_score_{{ enrollment.id }}" 
                                                       class="form-control form-control-sm total-score" 
                                                       readonly id="total_{{ enrollment.id }}"
                                                       value="{{ enrollment.result.total_score|default:'' }}">
                                            </td>
                                            <td>
                                                <span class="badge grade-badge" id="grade_{{ enrollment.id }}">
                                                    {{ enrollment.result.grade|default:'-' }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Mobile Card View -->
                        <div class="d-lg-none">
                            {% for enrollment in enrolled_students %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">{{ enrollment.student.matric_number }}</h6>
                                    <p class="card-text">{{ enrollment.student.get_full_name }}</p>
                                    
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <label class="form-label">CA Score (30)</label>
                                            <input type="number" name="ca_score_{{ enrollment.id }}" 
                                                   class="form-control ca-score" 
                                                   min="0" max="30" step="0.01"
                                                   value="{{ enrollment.result.ca_score|default:'' }}"
                                                   onchange="calculateTotal({{ enrollment.id }})">
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Exam Score (70)</label>
                                            <input type="number" name="exam_score_{{ enrollment.id }}" 
                                                   class="form-control exam-score" 
                                                   min="0" max="70" step="0.01"
                                                   value="{{ enrollment.result.exam_score|default:'' }}"
                                                   onchange="calculateTotal({{ enrollment.id }})">
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Total (100)</label>
                                            <input type="number" name="total_score_{{ enrollment.id }}" 
                                                   class="form-control total-score" 
                                                   readonly id="total_mobile_{{ enrollment.id }}"
                                                   value="{{ enrollment.result.total_score|default:'' }}">
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">Grade</label>
                                            <div class="form-control">
                                                <span class="badge grade-badge" id="grade_mobile_{{ enrollment.id }}">
                                                    {{ enrollment.result.grade|default:'-' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <a href="{% url 'lecturer_dashboard' %}" class="btn btn-secondary">Cancel</a>
                            <button type="button" class="btn btn-outline-warning" onclick="saveDraft()">
                                <i class="bi bi-save me-1"></i>Save as Draft
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-1"></i>Submit Results
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% elif selected_course %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-people display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No Students Enrolled</h4>
                    <p class="text-muted">No students are enrolled in this course for the selected session.</p>
                    <a href="{% url 'lecturer_enroll_students' %}" class="btn btn-primary">
                        <i class="bi bi-person-plus me-1"></i>Enroll Students
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function calculateTotal(enrollmentId) {
    const caInput = document.querySelector(`input[name="ca_score_${enrollmentId}"]`);
    const examInput = document.querySelector(`input[name="exam_score_${enrollmentId}"]`);
    const totalInput = document.getElementById(`total_${enrollmentId}`);
    const totalMobileInput = document.getElementById(`total_mobile_${enrollmentId}`);
    const gradeSpan = document.getElementById(`grade_${enrollmentId}`);
    const gradeMobileSpan = document.getElementById(`grade_mobile_${enrollmentId}`);

    const caScore = parseFloat(caInput.value) || 0;
    const examScore = parseFloat(examInput.value) || 0;
    const total = caScore + examScore;

    if (totalInput) totalInput.value = total.toFixed(2);
    if (totalMobileInput) totalMobileInput.value = total.toFixed(2);

    // Calculate grade
    let grade = '';
    let gradeClass = '';
    
    if (total >= 70) {
        grade = 'A';
        gradeClass = 'bg-success';
    } else if (total >= 60) {
        grade = 'B';
        gradeClass = 'bg-primary';
    } else if (total >= 50) {
        grade = 'C';
        gradeClass = 'bg-info';
    } else if (total >= 45) {
        grade = 'D';
        gradeClass = 'bg-warning';
    } else if (total > 0) {
        grade = 'F';
        gradeClass = 'bg-danger';
    } else {
        grade = '-';
        gradeClass = 'bg-secondary';
    }

    if (gradeSpan) {
        gradeSpan.textContent = grade;
        gradeSpan.className = `badge grade-badge ${gradeClass}`;
    }
    if (gradeMobileSpan) {
        gradeMobileSpan.textContent = grade;
        gradeMobileSpan.className = `badge grade-badge ${gradeClass}`;
    }
}

function calculateTotals() {
    const enrollmentIds = [];
    document.querySelectorAll('input[name^="ca_score_"]').forEach(input => {
        const enrollmentId = input.name.split('_')[2];
        enrollmentIds.push(enrollmentId);
    });

    enrollmentIds.forEach(id => calculateTotal(id));
}

function saveDraft() {
    const form = document.getElementById('resultsForm');
    const formData = new FormData(form);
    formData.append('save_as_draft', 'true');

    fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Results saved as draft successfully!');
        } else {
            alert('Error saving draft: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving draft');
    });
}

// Calculate totals on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateTotals();
});
</script>

{% endblock %}
