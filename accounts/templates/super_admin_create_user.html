{% extends 'base.html' %}

{% block title %}Create User - RMS{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    
    <!-- Clean Header -->
    <div style="text-align: center; margin-bottom: 48px;">
        <h1 style="font-size: 36px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; letter-spacing: -0.02em;">
            Create New User
        </h1>
        <p style="color: var(--text-secondary); font-size: 17px; font-weight: 400;">
            Add a new user to the system with role assignment
        </p>
    </div>

    <!-- Messages Display -->
    {% if messages %}
        <div style="margin-bottom: 32px;">
            {% for message in messages %}
                <div class="message-alert message-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- User Creation Form -->
    <div style="background: #FFFFFF; border: 1px solid var(--border-light); border-radius: 24px; padding: 32px; margin-bottom: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 8px 30px rgba(0,0,0,0.08); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        
        <form method="post">
            {% csrf_token %}
            
            <!-- Personal Information -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 24px; text-align: center;">
                    Personal Information
                </h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                            First Name
                        </label>
                        <input type="text" name="first_name" required 
                               style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                               onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                               onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                            Last Name
                        </label>
                        <input type="text" name="last_name" required 
                               style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                               onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                               onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                        Email Address
                    </label>
                    <input type="email" name="email" id="email" required
                           style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                           onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                           onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                           oninput="validateEmail(this)"
                           onblur="checkEmailExists(this)">
                    <div id="email-error" style="color: var(--ios-red); font-size: 14px; margin-top: 8px; display: none;"></div>
                </div>
            </div>

            <!-- Account Information -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 24px; text-align: center;">
                    Account Information
                </h3>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                        Username
                    </label>
                    <input type="text" name="username" id="username" required
                           style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                           onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                           onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                           oninput="validateUsername(this)"
                           onblur="checkUsernameExists(this)">
                    <div id="username-error" style="color: var(--ios-red); font-size: 14px; margin-top: 8px; display: none;"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                            Password
                        </label>
                        <div style="position: relative;">
                            <input type="password" name="password" id="password" required
                                   style="width: 100%; padding: 16px 50px 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                                   onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                                   onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                                   oninput="validatePassword(this)">
                            <button type="button" onclick="togglePassword('password')"
                                    style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 12px; padding: 4px;">
                                Show
                            </button>
                        </div>
                        <div id="password-error" style="color: var(--ios-red); font-size: 14px; margin-top: 8px; display: none;"></div>
                        <div id="password-strength" style="font-size: 12px; margin-top: 4px; display: none;">
                            <div style="display: flex; gap: 2px; margin-bottom: 4px;">
                                <div id="strength-bar-1" style="height: 4px; width: 25%; background: #e5e7eb; border-radius: 2px;"></div>
                                <div id="strength-bar-2" style="height: 4px; width: 25%; background: #e5e7eb; border-radius: 2px;"></div>
                                <div id="strength-bar-3" style="height: 4px; width: 25%; background: #e5e7eb; border-radius: 2px;"></div>
                                <div id="strength-bar-4" style="height: 4px; width: 25%; background: #e5e7eb; border-radius: 2px;"></div>
                            </div>
                            <div id="strength-text" style="color: var(--text-secondary);"></div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                            Confirm Password
                        </label>
                        <div style="position: relative;">
                            <input type="password" name="confirm_password" id="confirm_password" required
                                   style="width: 100%; padding: 16px 50px 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                                   onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                                   onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                                   oninput="validatePasswordMatch(this)">
                            <button type="button" onclick="togglePassword('confirm_password')"
                                    style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 12px; padding: 4px;">
                                Show
                            </button>
                        </div>
                        <div id="confirm-password-error" style="color: var(--ios-red); font-size: 14px; margin-top: 8px; display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Role Assignment -->
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 24px; text-align: center;">
                    Role Assignment
                </h3>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                        User Role
                    </label>
                    <select name="role" id="role" required onchange="toggleRoleFields()"
                            style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                            onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                            onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                        <option value="">Select a role</option>
                        {% for role_code, role_name in role_choices %}
                            <option value="{{ role_code }}">{{ role_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="faculty-field" style="margin-bottom: 24px; display: none;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                        Faculty
                    </label>
                    <select name="faculty_id" id="faculty" onchange="loadDepartments()"
                            style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                            onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                            onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                        <option value="">Select a faculty</option>
                        {% for faculty in faculties %}
                            <option value="{{ faculty.id }}">{{ faculty.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="department-field" style="margin-bottom: 24px; display: none;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px;">
                        Department
                    </label>
                    <select name="department_id" id="department"
                            style="width: 100%; padding: 16px 20px; border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px; background: #FFFFFF; transition: all 0.2s ease;"
                            onfocus="this.style.borderColor='var(--ios-blue)'; this.style.boxShadow='0 0 0 4px var(--ios-blue-ultra-light)'"
                            onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                        <option value="">Select a department</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 16px; justify-content: center;">
                <button type="submit" id="submit-btn"
                        style="background: var(--ios-blue); color: #FFFFFF; padding: 16px 32px; border: none; border-radius: 16px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);"
                        onmousedown="this.style.transform='scale(0.98)'"
                        onmouseup="this.style.transform='scale(1)'"
                        onmouseleave="this.style.transform='scale(1)'"
                        onclick="return validateForm()">
                    Create User
                </button>
                <a href="{% url 'super_admin_dashboard' %}" 
                   style="background: #FFFFFF; color: var(--text-primary); padding: 16px 32px; border: 1px solid var(--border-color); border-radius: 16px; font-weight: 600; font-size: 16px; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: inline-block;"
                   onmousedown="this.style.transform='scale(0.98)'"
                   onmouseup="this.style.transform='scale(1)'"
                   onmouseleave="this.style.transform='scale(1)'">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Department data for JavaScript -->
<script>
    const departmentsByFaculty = JSON.parse('{{ departments_json|escapejs }}');

    // Real-time validation functions
    function validateEmail(input) {
        const emailError = document.getElementById('email-error');
        const email = input.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email === '') {
            showError(emailError, '');
            setFieldState(input, 'normal');
        } else if (!emailRegex.test(email)) {
            showError(emailError, 'Please enter a valid email address');
            setFieldState(input, 'error');
        } else {
            showError(emailError, '');
            setFieldState(input, 'success');
        }
    }

    function validateUsername(input) {
        const usernameError = document.getElementById('username-error');
        const username = input.value.trim();

        if (username === '') {
            showError(usernameError, '');
            setFieldState(input, 'normal');
        } else if (username.length < 3) {
            showError(usernameError, 'Username must be at least 3 characters long');
            setFieldState(input, 'error');
        } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            showError(usernameError, 'Username can only contain letters, numbers, and underscores');
            setFieldState(input, 'error');
        } else {
            showError(usernameError, '');
            setFieldState(input, 'success');
        }
    }

    function validatePassword(input) {
        const passwordError = document.getElementById('password-error');
        const strengthIndicator = document.getElementById('password-strength');
        const password = input.value;

        if (password === '') {
            showError(passwordError, '');
            strengthIndicator.style.display = 'none';
            setFieldState(input, 'normal');
            return;
        }

        strengthIndicator.style.display = 'block';

        let errors = [];
        let strength = 0;

        if (password.length < 8) {
            errors.push('at least 8 characters');
        } else {
            strength++;
        }

        if (!/[a-z]/.test(password)) {
            errors.push('a lowercase letter');
        } else {
            strength++;
        }

        if (!/[A-Z]/.test(password)) {
            errors.push('an uppercase letter');
        } else {
            strength++;
        }

        if (!/[0-9]/.test(password)) {
            errors.push('a number');
        } else {
            strength++;
        }

        // Update strength bars
        updateStrengthBars(strength);

        if (errors.length > 0) {
            showError(passwordError, 'Password must contain ' + errors.join(', '));
            setFieldState(input, 'error');
        } else {
            showError(passwordError, '');
            setFieldState(input, 'success');
        }

        // Validate confirm password if it has a value
        const confirmPassword = document.getElementById('confirm_password');
        if (confirmPassword.value) {
            validatePasswordMatch(confirmPassword);
        }
    }

    function validatePasswordMatch(input) {
        const confirmError = document.getElementById('confirm-password-error');
        const password = document.getElementById('password').value;
        const confirmPassword = input.value;

        if (confirmPassword === '') {
            showError(confirmError, '');
            setFieldState(input, 'normal');
        } else if (password !== confirmPassword) {
            showError(confirmError, 'Passwords do not match');
            setFieldState(input, 'error');
        } else {
            showError(confirmError, '');
            setFieldState(input, 'success');
        }
    }

    function updateStrengthBars(strength) {
        const bars = ['strength-bar-1', 'strength-bar-2', 'strength-bar-3', 'strength-bar-4'];
        const strengthText = document.getElementById('strength-text');
        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e'];
        const labels = ['Weak', 'Fair', 'Good', 'Strong'];

        bars.forEach((barId, index) => {
            const bar = document.getElementById(barId);
            if (index < strength) {
                bar.style.background = colors[strength - 1];
            } else {
                bar.style.background = '#e5e7eb';
            }
        });

        if (strength > 0) {
            strengthText.textContent = labels[strength - 1];
            strengthText.style.color = colors[strength - 1];
        } else {
            strengthText.textContent = '';
        }
    }

    function showError(errorElement, message) {
        if (message) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        } else {
            errorElement.style.display = 'none';
        }
    }

    function setFieldState(input, state) {
        switch (state) {
            case 'error':
                input.style.borderColor = 'var(--ios-red)';
                input.style.boxShadow = '0 0 0 4px var(--ios-red-light)';
                break;
            case 'success':
                input.style.borderColor = '#22c55e';
                input.style.boxShadow = '0 0 0 4px rgba(34, 197, 94, 0.1)';
                break;
            default:
                input.style.borderColor = 'var(--border-color)';
                input.style.boxShadow = 'none';
        }
    }

    // Check if email exists (AJAX call)
    function checkEmailExists(input) {
        const email = input.value.trim();
        if (!email || !validateEmailFormat(email)) return;

        fetch('/api/super-admin/check-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({email: email})
        })
        .then(response => response.json())
        .then(data => {
            const emailError = document.getElementById('email-error');
            if (data.exists) {
                showError(emailError, 'A user with this email already exists');
                setFieldState(input, 'error');
            } else if (!emailError.textContent) {
                setFieldState(input, 'success');
            }
        })
        .catch(error => console.log('Email check failed:', error));
    }

    // Check if username exists (AJAX call)
    function checkUsernameExists(input) {
        const username = input.value.trim();
        if (!username || username.length < 3) return;

        fetch('/api/super-admin/check-username/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({username: username})
        })
        .then(response => response.json())
        .then(data => {
            const usernameError = document.getElementById('username-error');
            if (data.exists) {
                showError(usernameError, 'This username is already taken');
                setFieldState(input, 'error');
            } else if (!usernameError.textContent) {
                setFieldState(input, 'success');
            }
        })
        .catch(error => console.log('Username check failed:', error));
    }

    function validateEmailFormat(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function toggleRoleFields() {
        const role = document.getElementById('role').value;
        const facultyField = document.getElementById('faculty-field');
        const departmentField = document.getElementById('department-field');

        // Roles that require faculty
        const facultyRoles = ['HOD', 'FACULTY_DEAN', 'LECTURER'];
        // Roles that require department
        const departmentRoles = ['HOD', 'LECTURER'];

        if (facultyRoles.includes(role)) {
            facultyField.style.display = 'block';
            document.getElementById('faculty').required = true;
        } else {
            facultyField.style.display = 'none';
            document.getElementById('faculty').required = false;
            document.getElementById('faculty').value = '';
        }

        if (departmentRoles.includes(role)) {
            departmentField.style.display = 'block';
            document.getElementById('department').required = true;
        } else {
            departmentField.style.display = 'none';
            document.getElementById('department').required = false;
            document.getElementById('department').value = '';
        }

        // Clear department when role changes
        loadDepartments();
    }

    function loadDepartments() {
        const facultyId = document.getElementById('faculty').value;
        const departmentSelect = document.getElementById('department');

        // Clear existing options
        departmentSelect.innerHTML = '<option value="">Select a department</option>';

        if (facultyId && departmentsByFaculty[facultyId]) {
            departmentsByFaculty[facultyId].forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                departmentSelect.appendChild(option);
            });
        }
    }

    function validateForm() {
        let isValid = true;
        const errors = [];

        // Check all required fields
        const firstName = document.querySelector('input[name="first_name"]').value.trim();
        const lastName = document.querySelector('input[name="last_name"]').value.trim();
        const email = document.getElementById('email').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const role = document.getElementById('role').value;

        if (!firstName) errors.push('First name is required');
        if (!lastName) errors.push('Last name is required');
        if (!email) errors.push('Email is required');
        if (!username) errors.push('Username is required');
        if (!password) errors.push('Password is required');
        if (!confirmPassword) errors.push('Confirm password is required');
        if (!role) errors.push('Role is required');

        // Check for existing validation errors
        const errorElements = document.querySelectorAll('[id$="-error"]');
        errorElements.forEach(element => {
            if (element.style.display !== 'none' && element.textContent.trim()) {
                isValid = false;
            }
        });

        // Check password match
        if (password !== confirmPassword) {
            errors.push('Passwords do not match');
            isValid = false;
        }

        // Check role-specific requirements
        const facultyRoles = ['HOD', 'FACULTY_DEAN', 'LECTURER'];
        const departmentRoles = ['HOD', 'LECTURER'];

        if (facultyRoles.includes(role)) {
            const faculty = document.getElementById('faculty').value;
            if (!faculty) {
                errors.push('Faculty is required for this role');
                isValid = false;
            }
        }

        if (departmentRoles.includes(role)) {
            const department = document.getElementById('department').value;
            if (!department) {
                errors.push('Department is required for this role');
                isValid = false;
            }
        }

        if (errors.length > 0) {
            isValid = false;
        }

        if (!isValid) {
            alert('Please fix the following errors before submitting:\n\n' + errors.join('\n'));
            return false;
        }

        return true;
    }

    // Password toggle function
    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.parentElement.querySelector('button');

        if (field.type === 'password') {
            field.type = 'text';
            button.textContent = 'Hide';
        } else {
            field.type = 'password';
            button.textContent = 'Show';
        }
    }
</script>

<style>
    /* Message alert styles */
    .message-alert {
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 16px;
        font-size: 16px;
        font-weight: 500;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .message-error {
        background: rgba(255, 59, 48, 0.1);
        color: #FF3B30;
        border-left: 4px solid #FF3B30;
    }

    .message-warning {
        background: #FFF3CD;
        color: #856404;
        border-left: 4px solid #FFC107;
    }

    .message-success {
        background: #D4EDDA;
        color: #155724;
        border-left: 4px solid #28A745;
    }

    .message-info {
        background: #D1ECF1;
        color: #0C5460;
        border-left: 4px solid #17A2B8;
    }
</style>

{% endblock %}
