{% extends 'base.html' %} {% load role_tags %} {% block title %}Delegation History - RMS{% endblock %} {% block content %} <style> :root { --royal-blue: #1e3a8a; --royal-blue-light: #3b82f6; --royal-blue-ultra-light: rgba(30, 58, 138, 0.1); --royal-blue-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); --ios-green: #3b82f6; --ios-orange: #1e40af; --ios-red: #dc2626; --text-primary: #1D1D1F; --text-secondary: #86868B; --surface-primary: #FFFFFF; --surface-secondary: #F2F2F7; --border-light: #E5E5EA; } .history-container { max-width: 1200px; margin: 0 auto; padding: 20px; } .filter-section { background: var(--surface-primary); border: 1px solid var(--border-light); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); } .delegation-card { background: var(--surface-primary); border: 1px solid var(--border-light); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); } .delegation-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); } .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; } .status-active { background: #d4edda; color: #155724; } .status-expired { background: #fff3cd; color: #856404; } .status-revoked { background: #f8d7da; color: #721c24; } .timeline-item { border-left: 3px solid var(--royal-blue); padding-left: 16px; margin-bottom: 16px; position: relative; } .timeline-item::before { content: ''; position: absolute; left: -6px; top: 8px; width: 10px; height: 10px; border-radius: 50%; background: var(--royal-blue); } .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; } .stat-card { background: var(--surface-primary); border: 1px solid var(--border-light); border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); } .stat-number { font-size: 32px; font-weight: 700; color: var(--royal-blue); margin-bottom: 8px; } .stat-label { color: var(--text-secondary); font-size: 14px; } @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .delegation-card { padding: 16px; } } </style> <div class="history-container"> <!-- Header --> <div style="text-align: center; margin-bottom: 32px;"> <h1 style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin: 0 0 12px 0;"> Delegation History & Audit </h1> <p style="color: var(--text-secondary); font-size: 18px; margin: 0;"> Comprehensive view of all permission delegations </p> </div> <!-- Statistics --> <div class="stats-grid"> <div class="stat-card"> <div class="stat-number">{{ stats.total_delegations }}</div> <div class="stat-label">Total Delegations</div> </div> <div class="stat-card"> <div class="stat-number">{{ stats.active_delegations }}</div> <div class="stat-label">Currently Active</div> </div> <div class="stat-card"> <div class="stat-number">{{ stats.expired_delegations }}</div> <div class="stat-label">Expired</div> </div> <div class="stat-card"> <div class="stat-number">{{ stats.revoked_delegations }}</div> <div class="stat-label">Revoked</div> </div> </div> <!-- Filters --> <div class="filter-section"> <h3 style="margin: 0 0 16px 0; font-weight: 600;"> <i class="fas fa-filter" style="margin-right: 8px; color: var(--royal-blue);"></i> Filter Delegations </h3> <form method="get" class="row g-3"> <div class="col-md-3"> <label for="status" class="form-label">Status</label> <select class="form-control" id="status" name="status"> <option value="">All Statuses</option> <option value="ACTIVE" {% if request.GET.status == 'ACTIVE' %}selected{% endif %}>Active</option> <option value="EXPIRED" {% if request.GET.status == 'EXPIRED' %}selected{% endif %}>Expired</option> <option value="REVOKED" {% if request.GET.status == 'REVOKED' %}selected{% endif %}>Revoked</option> </select> </div> <div class="col-md-3"> <label for="role" class="form-label">Role</label> <select class="form-control" id="role" name="role"> <option value="">All Roles</option> <option value="HOD" {% if request.GET.role == 'HOD' %}selected{% endif %}>Head of Department</option> <option value="FACULTY_DEAN" {% if request.GET.role == 'FACULTY_DEAN' %}selected{% endif %}>Faculty Dean</option> <option value="EXAM_OFFICER" {% if request.GET.role == 'EXAM_OFFICER' %}selected{% endif %}>Exam Officer</option> <option value="LECTURER" {% if request.GET.role == 'LECTURER' %}selected{% endif %}>Lecturer</option> <option value="DAAA" {% if request.GET.role == 'DAAA' %}selected{% endif %}>DAAA</option> <option value="SENATE" {% if request.GET.role == 'SENATE' %}selected{% endif %}>Senate</option> </select> </div> <div class="col-md-3"> <label for="date_from" class="form-label">From Date</label> <input type="date" class="form-control" id="date_from" name="date_from" value="{{ request.GET.date_from }}"> </div> <div class="col-md-3"> <label for="date_to" class="form-label">To Date</label> <input type="date" class="form-control" id="date_to" name="date_to" value="{{ request.GET.date_to }}"> </div> <div class="col-12"> <button type="submit" class="btn btn-primary"> <i class="fas fa-search" style="margin-right: 8px;"></i> Apply Filters </button> <a href="{% url 'super_admin_delegation_history' %}" class="btn btn-secondary ms-2"> <i class="fas fa-times" style="margin-right: 8px;"></i> Clear Filters </a> <a href="{% url 'super_admin_export_delegation_report' %}?{{ request.GET.urlencode }}" class="btn btn-success ms-2"> <i class="fas fa-download" style="margin-right: 8px;"></i> Export Report </a> </div> </form> </div> <!-- Delegation History --> <div class="delegation-history"> <h3 style="margin: 0 0 20px 0; font-weight: 600;"> <i class="fas fa-history" style="margin-right: 8px; color: var(--royal-blue);"></i> Delegation Records ({{ delegations|length }} of {{ total_count }}) </h3> {% for delegation in delegations %} <div class="delegation-card"> <div class="row"> <div class="col-md-8"> <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"> <h5 style="margin: 0; font-weight: 600;"> {% get_role_display_name delegation.delegated_role.role %} </h5> <span class="status-badge status-{{ delegation.status|lower }}"> {{ delegation.get_status_display }} </span> {% if delegation.is_expired %} <span class="badge bg-warning text-dark"> <i class="fas fa-clock" style="margin-right: 4px;"></i> {% if delegation.end_date %} Expired {{ delegation.end_date|timesince }} ago {% else %} Manually Expired {% endif %} </span> {% endif %} </div> <div style="margin-bottom: 12px;"> <strong>From:</strong> {{ delegation.delegator.get_full_name }} <span style="color: var(--text-secondary);">({{ delegation.delegator.username }})</span> <br> <strong>To:</strong> {{ delegation.delegate.get_full_name }} <span style="color: var(--text-secondary);">({{ delegation.delegate.username }})</span> <br> <strong>Created by:</strong> {{ delegation.created_by.get_full_name }} </div> {% if delegation.reason %} <div style="margin-bottom: 12px;"> <strong>Reason:</strong> {{ delegation.reason|truncatewords:20 }} </div> {% endif %} {% if delegation.delegated_role.faculty or delegation.delegated_role.department %} <div style="margin-bottom: 12px; font-size: 12px; color: var(--text-secondary);"> {% if delegation.delegated_role.faculty %} <i class="fas fa-building" style="margin-right: 4px;"></i> {{ delegation.delegated_role.faculty.name }} {% endif %} {% if delegation.delegated_role.department %} | <i class="fas fa-sitemap" style="margin-right: 4px;"></i> {{ delegation.delegated_role.department.name }} {% endif %} </div> {% endif %} </div> <div class="col-md-4"> <div class="timeline-item"> <div style="font-size: 12px; color: var(--text-secondary);">Created</div> <div style="font-weight: 600;">{{ delegation.created_at|date:"M d, Y H:i" }}</div> </div> {% if delegation.start_date %} <div class="timeline-item"> <div style="font-size: 12px; color: var(--text-secondary);">Start Date</div> <div style="font-weight: 600;">{{ delegation.start_date|date:"M d, Y H:i" }}</div> </div> {% endif %} {% if delegation.end_date %} <div class="timeline-item"> <div style="font-size: 12px; color: var(--text-secondary);"> {% if delegation.status == 'EXPIRED' %}End Date{% else %}Expires{% endif %} </div> <div style="font-weight: 600;">{{ delegation.end_date|date:"M d, Y H:i" }}</div> {% if delegation.status == 'ACTIVE' and delegation.end_date %} <div style="font-size: 11px; color: var(--ios-orange);"> {{ delegation.get_time_remaining }} </div> {% endif %} </div> {% endif %} {% if delegation.status == 'ACTIVE' %} <div style="margin-top: 16px;"> <button class="btn btn-danger btn-sm revoke-delegation-btn" data-delegation-id="{{ delegation.id }}" data-delegate-name="{{ delegation.delegate.get_full_name }}" data-role-display="{% get_role_display_name delegation.delegated_role.role %}"> <i class="fas fa-times" style="margin-right: 4px;"></i> Revoke </button> </div> {% endif %} </div> </div> </div> {% empty %} <div style="text-align: center; padding: 40px; color: var(--text-secondary);"> <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px;"></i> <h4>No delegations found</h4> <p>No delegations match your current filters.</p> </div> {% endfor %} </div> <!-- Pagination --> {% if is_paginated %} <nav aria-label="Delegation pagination" style="margin-top: 32px;"> <ul class="pagination justify-content-center"> {% if page_obj.has_previous %} <li class="page-item"> <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">Previous</a> </li> {% endif %} {% for num in page_obj.paginator.page_range %} {% if page_obj.number == num %} <li class="page-item active"> <span class="page-link">{{ num }}</span> </li> {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item"> <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a> </li> {% endif %} {% endfor %} {% if page_obj.has_next %} <li class="page-item"> <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">Next</a> </li> {% endif %} </ul> </nav> {% endif %} </div> <!-- Revocation Modal --> <div class="modal " id="revokeModal" tabindex="-1" aria-labelledby="revokeModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="revokeModalLabel">Revoke Delegation</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <form method="post" id="revokeForm"> {% csrf_token %} <div class="modal-body"> <p>Are you sure you want to revoke the <strong id="roleDisplay"></strong> delegation for <strong id="delegateName"></strong>?</p> <div class="mb-3"> <label for="revocationReason" class="form-label">Reason for revocation (optional)</label> <textarea class="form-control" id="revocationReason" name="reason" rows="3" placeholder="Provide a reason for revoking this delegation..."></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="submit" class="btn btn-danger">Revoke Delegation</button> </div> </form> </div> </div> </div> <script> document.addEventListener('DOMContentLoaded', function() { // Handle revocation buttons document.querySelectorAll('.revoke-delegation-btn').forEach(button => { button.addEventListener('click', function() { const delegationId = this.getAttribute('data-delegation-id'); const delegateName = this.getAttribute('data-delegate-name'); const roleDisplay = this.getAttribute('data-role-display'); // Update modal content document.getElementById('delegateName').textContent = delegateName; document.getElementById('roleDisplay').textContent = roleDisplay; document.getElementById('revokeForm').action = `/super-admin/revoke-delegation/${delegationId}/`; // Show modal const modal = new bootstrap.Modal(document.getElementById('revokeModal')); modal.show(); }); }); }); </script> {% endblock %} 