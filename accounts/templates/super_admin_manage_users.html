{% extends 'base.html' %} {% block title %}Manage Users - RMS{% endblock %} {% block content %} <style> :root { --ios-red: #dc2626; /* School brand red */ --ios-red-light: rgba(220, 38, 38, 0.1); --ios-red-ultra-light: rgba(220, 38, 38, 0.05); --ios-blue: #007AFF; --ios-blue-light: #3b82f6; --ios-blue-ultra-light: rgba(0, 122, 255, 0.1); --ios-green: #3b82f6; /* Changed to blue variant */ --ios-orange: #1e40af; /* Changed to dark blue */ --text-primary: #1D1D1F; --text-secondary: #86868B; --text-tertiary: #C7C7CC; --surface-primary: #FFFFFF; --surface-secondary: #F2F2F7; --border-color: #D1D1D6; --border-light: #E5E5EA; --royal-blue-gradient: linear-gradient(135deg, #007AFF 0%, #1e40af 100%); } /* MOBILE RESPONSIVENESS FOR USER MANAGEMENT */ @media (max-width: 768px) { .search-filters-container { grid-template-columns: 1fr !important; gap: 16px !important; } .search-filters-container > div { width: 100%; } .search-filters-container select { min-width: 100% !important; } .search-filters-container button { width: 100%; justify-self: stretch; } /* Mobile-responsive user cards */ .user-card { margin-bottom: 16px !important; } /* Statistics cards mobile layout */ .stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 12px !important; } /* Header actions mobile layout */ .header-actions { flex-direction: column !important; gap: 12px !important; } .header-actions > * { width: 100% !important; text-align: center !important; } } @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr !important; } /* Prevent content overflow */ .container { padding: 12px !important; } .user-card { padding: 16px !important; } } </style> <div> <div style="max-width: 1200px; margin: 0 auto;"> <!-- Header Card --> <div style="background: rgba(255,255,255,0.95); border: 1px solid var(--border-light); border-radius: 24px; padding: 32px; margin-bottom: 32px; box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 8px 30px rgba(0,0,0,0.08); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);"> <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;"> <div> <h1 style="font-size: 28px; font-weight: 700; color: var(--text-primary); margin: 0 0 8px 0; letter-spacing: -0.5px;"> Manage Users </h1> <p style="color: var(--text-secondary); margin: 0; font-size: 16px; font-weight: 500;"> Create, view, edit, and manage all system users </p> </div> <div class="d-flex flex-column flex-md-row gap-2"> <a href="{% url 'super_admin_create_user' %}" class="btn btn-primary btn-lg d-flex align-items-center justify-content-center" style="border-radius: 16px;"> <i class="bi bi-plus-lg me-2"></i> Create New User </a> <a href="{% url 'super_admin_dashboard' %}" class="btn btn-outline-secondary btn-lg d-flex align-items-center justify-content-center" style="border-radius: 16px;"> <i class="bi bi-arrow-left me-2"></i> Back to Dashboard </a> </div> </div> </div> <!-- Statistics Cards --> <div class="row g-3 mb-4"> <div class="col-6 col-md-3"> <div class="card text-white h-100 shadow-sm" style="background: var(--royal-blue-gradient); border-radius: 20px;"> <div class="card-body p-3 p-md-4 text-center"> <div class="display-6 fw-bold mb-2">{{ total_users }}</div> <div class="fs-6 opacity-75">Total Users</div> </div> </div> </div> <div class="col-6 col-md-3"> <div class="card text-white h-100 shadow-sm" style="background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%); border-radius: 20px;"> <div class="card-body p-3 p-md-4 text-center"> <div class="display-6 fw-bold mb-2">{{ active_users }}</div> <div class="fs-6 opacity-75">Active Users</div> </div> </div> </div> <div class="col-6 col-md-3"> <div class="card text-white h-100 shadow-sm" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); border-radius: 20px;"> <div class="card-body p-3 p-md-4 text-center"> <div class="display-6 fw-bold mb-2">{{ users_with_roles_count }}</div> <div class="fs-6 opacity-75">With Roles</div> </div> </div> </div> <div class="col-6 col-md-3"> <div class="card text-white h-100 shadow-sm" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 20px;"> <div class="card-body p-3 p-md-4 text-center"> <div class="display-6 fw-bold mb-2">{{ users_without_roles_count }}</div> <div class="fs-6 opacity-75">Without Roles</div> </div> </div> </div> </div> <!-- Search and Filters Card --> <div class="card shadow-sm mb-4" style="border-radius: 24px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);"> <div class="card-body p-4"> <div class="row g-3 align-items-end"> <div class="col-12 col-md-6 col-lg-5"> <label for="userSearch" class="form-label fw-semibold text-dark">Search Users</label> <input type="text" id="userSearch" class="form-control form-control-lg border-danger" placeholder="Search by name, email, username..." style="border-radius: 16px; border-width: 2px;"> </div> <div class="col-12 col-md-4 col-lg-3"> <label for="roleFilter" class="form-label fw-semibold text-dark">Filter by Role</label> <select id="roleFilter" class="form-select form-select-lg" style="border-radius: 16px;"> <option value="">All Roles</option> <option value="SUPER_ADMIN">Super Admin</option> <option value="FACULTY_DEAN">Faculty Dean</option> <option value="HOD">Head of Department</option> <option value="LECTURER">Lecturer</option> <option value="EXAM_OFFICER">Exam Officer</option> <option value="ADMISSION_OFFICER">Admission Officer</option> <option value="DAAA">DAAA</option> <option value="SENATE">Senate</option> </select> </div> <div class="col-12 col-md-2 col-lg-4 d-grid"> <button onclick="filterUsers()" class="btn btn-primary btn-lg" style="border-radius: 16px;"> <i class="bi bi-funnel me-2"></i>Filter </button> </div> </div> </div> </div> <!-- Users Without Roles Section --> {% if users_without_roles %} <div class="card shadow-sm mb-4" style="border-radius: 20px; backdrop-filter: blur(20px);"> <div class="card-body p-4"> <h2 class="h4 fw-bold text-warning mb-4 d-flex align-items-center"> <i class="bi bi-exclamation-triangle me-2"></i> Users Without Roles ({{ users_without_roles_count }}) </h2> <div class="row g-3"> {% for user in users_without_roles %} <div class="col-12 col-md-6 col-lg-4"> <div class="card border-warning h-100 shadow-sm" style="border-radius: 16px; border-width: 2px;"> <div class="card-body p-3"> <div class="d-flex justify-content-between align-items-start mb-3"> <div class="flex-grow-1"> <h5 class="card-title mb-2 fw-bold text-dark">{{ user.get_full_name }}</h5> <p class="card-text text-muted mb-1 small">{{ user.email }}</p> <p class="card-text text-muted mb-0" style="font-size: 0.75rem;">@{{ user.username }}</p> </div> <span class="badge bg-warning text-dark rounded-pill"> No Role </span> </div> <!-- Warning Message --> <div class="alert alert-warning py-2 px-3 mb-3 small text-center" role="alert"> <i class="bi bi-exclamation-triangle me-1"></i> No roles assigned - User cannot access system features </div> <!-- User Status --> <div class="d-flex justify-content-between align-items-center mb-3"> <small class="text-muted"> Joined: {{ user.date_joined|date:"M d, Y" }} </small> <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}"> {% if user.is_active %}Active{% else %}Inactive{% endif %} </span> </div> <div class="d-flex flex-wrap gap-1"> <a href="{% url 'super_admin_user_details' user.id %}" class="btn btn-primary btn-sm"> <i class="bi bi-eye me-1"></i>View </a> <a href="{% url 'super_admin_edit_user' user.id %}" class="btn btn-secondary btn-sm"> <i class="bi bi-person-plus me-1"></i>Assign Role </a> <button class="btn btn-outline-danger btn-sm delete-user-btn" data-user-id="{{ user.id }}" data-user-name="{{ user.get_full_name }}"> <i class="bi bi-trash me-1"></i>Delete </button> </div> </div> </div> </div> {% endfor %} </div> </div> {% endif %} <!-- Users with Non-Faculty Roles Section --> {% if users_with_non_faculty_roles %} <div class="card shadow-sm mb-4" style="border-radius: 20px; backdrop-filter: blur(20px);"> <div class="card-body p-4"> <h2 class="h4 fw-bold text-info mb-4 d-flex align-items-center"> <i class="bi bi-shield-check me-2"></i> System Administrators ({{ users_with_non_faculty_roles_count }}) </h2> <div class="row g-3"> {% for user in users_with_non_faculty_roles %} <div class="col-12 col-md-6 col-lg-4"> <div class="card border-info h-100 shadow-sm" style="border-radius: 16px; border-width: 2px;"> <div class="card-body p-3"> <div class="d-flex justify-content-between align-items-start mb-3"> <div class="flex-grow-1"> <h5 class="card-title mb-1 fw-bold">{{ user.get_full_name }}</h5> <p class="card-text text-muted small mb-2">{{ user.email }}</p> <p class="card-text text-muted small mb-0">@{{ user.username }}</p> </div> </div> <!-- User Roles --> <div class="mb-3"> {% for role in user.rms_roles.all %} <span class="badge bg-info me-1 mb-1" style="font-size: 10px;"> {{ role.get_role_display }} </span> {% endfor %} </div> <!-- User Status --> <div class="d-flex justify-content-between align-items-center mb-3"> <small class="text-muted"> Joined: {{ user.date_joined|date:"M d, Y" }} </small> <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}"> {% if user.is_active %}Active{% else %}Inactive{% endif %} </span> </div> <div class="d-flex flex-wrap gap-1"> <a href="{% url 'super_admin_user_details' user.id %}" class="btn btn-primary btn-sm"> <i class="bi bi-eye me-1"></i>View </a> <a href="{% url 'super_admin_edit_user' user.id %}" class="btn btn-secondary btn-sm"> <i class="bi bi-pencil me-1"></i>Edit </a> <button class="btn btn-outline-danger btn-sm delete-user-btn" data-user-id="{{ user.id }}" data-user-name="{{ user.get_full_name }}"> <i class="bi bi-trash me-1"></i>Delete </button> </div> </div> </div> </div> {% endfor %} </div> </div> {% endif %} <!-- Users by Faculty Section --> {% if faculty_groups %} {% for faculty_name, faculty_data in faculty_groups.items %} <div class="card shadow-sm mb-4" style="border-radius: 20px;"> <div class="card-body p-4"> <h2 class="h4 fw-bold text-primary mb-4 d-flex align-items-center"> <i class="bi bi-building me-2"></i> {{ faculty_name }} ({{ faculty_data.users|length }} users) </h2> <div class="row g-3"> {% for user in faculty_data.users %} <div class="col-12 col-md-6 col-lg-4"> <div class="card h-100 shadow-sm" style="border-radius: 16px;"> <div class="card-body p-3"> <div class="d-flex justify-content-between align-items-start mb-3"> <div class="flex-grow-1"> <h5 class="card-title mb-2 fw-bold text-dark">{{ user.get_full_name }}</h5> <p class="card-text text-muted mb-1 small">{{ user.email }}</p> <p class="card-text text-muted mb-0" style="font-size: 0.75rem;">@{{ user.username }}</p> </div> </div> <div class="d-flex flex-wrap gap-1 mb-3"> <a href="{% url 'super_admin_user_details' user.id %}" class="btn btn-primary btn-sm"> <i class="bi bi-eye me-1"></i>View </a> <a href="{% url 'super_admin_edit_user' user.id %}" class="btn btn-secondary btn-sm"> <i class="bi bi-pencil me-1"></i>Edit </a> <button class="btn btn-info btn-sm permission-modal-btn" data-user-id="{{ user.id }}" data-user-name="{{ user.get_full_name }}"> <i class="bi bi-person-check me-1"></i>Delegate </button> <button class="btn btn-outline-danger btn-sm delete-user-btn" data-user-id="{{ user.id }}" data-user-name="{{ user.get_full_name }}"> <i class="bi bi-trash me-1"></i>Delete </button> </div> <!-- User Roles --> <div class="mb-3"> <div class="small fw-semibold text-muted mb-2">Roles:</div> <div class="d-flex flex-wrap gap-1"> {% for role in user.rms_roles.all %} <span class="badge bg-primary rounded-pill"> {{ role.get_role_display }} {% if role.department %} - {{ role.department.name }}{% endif %} </span> {% endfor %} </div> </div> <!-- User Status --> <div class="d-flex justify-content-between align-items-center"> <small class="text-muted"> Joined: {{ user.date_joined|date:"M d, Y" }} </small> <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}"> {% if user.is_active %}Active{% else %}Inactive{% endif %} </span> </div> </div> </div> </div> {% endfor %} </div> </div> </div> {% endfor %} {% endif %} <!-- Empty State --> {% if not users_without_roles and not users_with_non_faculty_roles and not faculty_groups %} <div class="card shadow-sm text-center" style="border-radius: 20px;"> <div class="card-body p-5"> <i class="bi bi-people display-1 text-muted mb-3"></i> <h3 class="h5 mb-3">No Users Found</h3> <p class="text-muted mb-4">Start by creating your first user.</p> <a href="{% url 'super_admin_create_user' %}" class="btn btn-primary"> <i class="bi bi-plus-lg me-2"></i>Create First User </a> </div> </div> {% endif %} </div> </div> <!-- Create Faculty Modal --> <div id="createFacultyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px);"> <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 32px; width: 90%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);"> <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0 0 24px 0;">Create New Faculty</h2> <form id="createFacultyForm" method="post" action="{% url 'super_admin_create_faculty' %}"> {% csrf_token %} <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Faculty Name</label> <input type="text" name="faculty_name" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;"> </div> <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Faculty Code</label> <input type="text" name="faculty_code" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;"> </div> <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Description</label> <textarea name="description" rows="3" style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; resize: vertical;"></textarea> </div> <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 24px 0 16px 0;">Faculty Dean Details</h3> <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;"> <div> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">First Name</label> <input type="text" name="dean_first_name" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;"> </div> <div> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Last Name</label> <input type="text" name="dean_last_name" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;"> </div> </div> <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Email</label> <input type="email" name="dean_email" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;"> </div> <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Username</label> <input type="text" name="dean_username" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;"> </div> <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px;"> <button type="button" onclick="hideFacultyModal()" style="background: var(--surface-secondary); color: var(--text-primary); padding: 12px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;"> Cancel </button> <button type="submit" style="background: var(--royal-blue-gradient); color: white; padding: 12px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;"> Create Faculty & Dean </button> </div> </form> </div> </div> <!-- Permission Delegation Modal --> <div id="permissionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(5px);"> <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 32px; width: 90%; max-width: 600px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;"> <h2 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0 0 24px 0;">Grant Role Permissions</h2> <form id="delegatePermissionForm" method="post" action="{% url 'super_admin_delegate_permission' %}"> {% csrf_token %} <input type="hidden" id="delegate_user_id" name="delegate_user_id"> <!-- User Info --> <div style="background: var(--surface-secondary); padding: 16px; border-radius: 12px; margin-bottom: 24px;"> <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0 0 8px 0;">Granting role permissions to:</h3> <div id="delegate_user_info" style="font-size: 18px; font-weight: 600; color: var(--royal-blue);"></div> </div> <!-- Select Original Role Holder --> <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Select Role Holder to Delegate From</label> <select id="delegated_user_role_id" name="delegated_user_role_id" required style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px;" onchange="updateRoleInfo()"> <option value="">Loading role holders...</option> </select> <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"> Choose whose role permissions you want to temporarily delegate </div> </div> <!-- Selected Role Info --> <div id="role_info" style="margin-bottom: 20px; display: none;"> <div style="background: var(--surface-secondary); padding: 16px; border-radius: 12px;"> <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Role to be delegated:</div> <div id="role_details" style="font-size: 16px; color: var(--ios-blue); font-weight: 600;"></div> </div> </div> <!-- Reason --> <div style="margin-bottom: 20px;"> <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Reason for Delegation</label> <textarea id="reason" name="reason" required rows="2" style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; resize: vertical;" placeholder="Brief reason for delegating this role..."></textarea> </div> <!-- Warning --> <div style="background: var(--ios-blue-ultra-light); border: 1px solid var(--ios-blue); color: var(--ios-blue); padding: 16px; border-radius: 12px; margin-bottom: 24px;"> <div style="font-weight: 600; margin-bottom: 8px;">Important Notes:</div> <ul style="margin: 0; padding-left: 20px; font-size: 14px;"> <li>This grants temporary role permissions to the user</li> <li>The user will have full permissions of the selected role</li> <li>All actions will be logged and audited</li> <li>You can revoke this delegation anytime from the delegations page</li> </ul> </div> <div style="display: flex; gap: 12px; justify-content: flex-end;"> <button type="button" onclick="hidePermissionModal()" style="background: var(--surface-secondary); color: var(--text-primary); padding: 12px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;"> Cancel </button> <button type="submit" style="background: var(--royal-blue-gradient); color: white; padding: 12px 24px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;"> Delegate Role </button> </div> </form> </div> </div> <script> function filterUsers() { const searchTerm = document.getElementById('userSearch').value.toLowerCase(); const roleFilter = document.getElementById('roleFilter').value; const userCards = document.querySelectorAll('.user-card'); userCards.forEach(card => { const userName = card.querySelector('h3').textContent.toLowerCase(); const userEmail = card.querySelector('p').textContent.toLowerCase(); const userRoles = Array.from(card.querySelectorAll('span')).map(span => span.textContent); const matchesSearch = userName.includes(searchTerm) || userEmail.includes(searchTerm); const matchesRole = !roleFilter || userRoles.some(role => role.includes(roleFilter)); if (matchesSearch && matchesRole) { card.style.display = 'block'; } else { card.style.display = 'none'; } }); } // Faculty modal functions function showCreateFacultyModal() { document.getElementById('createFacultyModal').style.display = 'block'; } function hideFacultyModal() { document.getElementById('createFacultyModal').style.display = 'none'; } // Permission delegation modal function showPermissionModal(userId, userName) { document.getElementById('delegate_user_id').value = userId; document.getElementById('delegate_user_info').textContent = userName; // Load all role holders when modal opens loadAllRoleHolders(); document.getElementById('permissionModal').style.display = 'block'; } function hidePermissionModal() { document.getElementById('permissionModal').style.display = 'none'; document.getElementById('delegatePermissionForm').reset(); } // Load all role holders function loadAllRoleHolders() { const roleHolderSelect = document.getElementById('delegated_user_role_id'); // Show loading roleHolderSelect.innerHTML = '<option value="">Loading role holders...</option>'; // Fetch all users with roles fetch('/api/super-admin/get-all-role-holders/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }, body: JSON.stringify({}) }) .then(response => response.json()) .then(data => { roleHolderSelect.innerHTML = '<option value="">Select a role holder to delegate from</option>'; if (data.status === 'success' && data.role_holders) { data.role_holders.forEach(holder => { const option = document.createElement('option'); option.value = holder.user_role_id; option.textContent = `${holder.user_name} - ${holder.role_display}`; if (holder.faculty_name) { option.textContent += ` (${holder.faculty_name}`; if (holder.department_name) { option.textContent += ` - ${holder.department_name}`; } option.textContent += ')'; } // Store role info in data attributes option.dataset.role = holder.role; option.dataset.roleName = holder.role_display; option.dataset.facultyName = holder.faculty_name || ''; option.dataset.departmentName = holder.department_name || ''; roleHolderSelect.appendChild(option); }); } }) .catch(error => { console.error('Error loading role holders:', error); roleHolderSelect.innerHTML = '<option value="">Error loading role holders</option>'; }); } // Show role info when role holder is selected function updateRoleInfo() { const select = document.getElementById('delegated_user_role_id'); const roleInfo = document.getElementById('role_info'); const roleDetails = document.getElementById('role_details'); if (select.value) { const selectedOption = select.options[select.selectedIndex]; const roleName = selectedOption.dataset.roleName; const facultyName = selectedOption.dataset.facultyName; const departmentName = selectedOption.dataset.departmentName; let roleText = roleName; if (facultyName) { roleText += ` of ${facultyName}`; if (departmentName) { roleText += ` - ${departmentName}`; } } roleDetails.textContent = roleText; roleInfo.style.display = 'block'; } else { roleInfo.style.display = 'none'; } } // Load departments for selected faculty function loadDepartmentsForFaculty() { const facultyId = document.getElementById('faculty').value; const departmentSelect = document.getElementById('department'); if (!facultyId) { departmentSelect.innerHTML = '<option value="">Select department</option>'; return; } // Fetch departments for this faculty fetch('/super-admin/get-departments/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }, body: JSON.stringify({faculty_id: facultyId}) }) .then(response => response.json()) .then(data => { departmentSelect.innerHTML = '<option value="">Select department</option>'; data.departments.forEach(dept => { const option = document.createElement('option'); option.value = dept.id; option.textContent = dept.name; departmentSelect.appendChild(option); }); // Auto-select department if delegator has one const delegatorSelect = document.getElementById('delegator'); const selectedOption = delegatorSelect.options[delegatorSelect.selectedIndex]; if (selectedOption && selectedOption.dataset.department) { departmentSelect.value = selectedOption.dataset.department; } }) .catch(error => { console.error('Error loading departments:', error); departmentSelect.innerHTML = '<option value="">Error loading departments</option>'; }); } // Real-time search document.getElementById('userSearch').addEventListener('input', filterUsers); document.getElementById('roleFilter').addEventListener('change', filterUsers); // Close modals when clicking outside document.getElementById('createFacultyModal').addEventListener('click', function(e) { if (e.target === this) { hideFacultyModal(); } }); document.getElementById('permissionModal').addEventListener('click', function(e) { if (e.target === this) { hidePermissionModal(); } }); // Event listeners for buttons document.addEventListener('DOMContentLoaded', function() { // Delete user buttons document.querySelectorAll('.delete-user-btn').forEach(button => { button.addEventListener('click', function() { const userId = this.dataset.userId; const userName = this.dataset.userName; deleteUser(userId, userName); }); }); // Permission modal buttons document.querySelectorAll('.permission-modal-btn').forEach(button => { button.addEventListener('click', function() { const userId = this.dataset.userId; const userName = this.dataset.userName; showPermissionModal(userId, userName); }); }); }); // Show Bootstrap message function function showMessage(type, message) { // Remove existing messages const existingMessages = document.querySelectorAll('#dynamic-messages .alert'); existingMessages.forEach(msg => msg.remove()); // Create message container if it doesn't exist let messageContainer = document.getElementById('dynamic-messages'); if (!messageContainer) { messageContainer = document.createElement('div'); messageContainer.id = 'dynamic-messages'; messageContainer.className = 'position-fixed top-0 start-50 translate-middle-x mt-3'; messageContainer.style.zIndex = '1055'; messageContainer.style.minWidth = '300px'; messageContainer.style.maxWidth = '90vw'; document.body.appendChild(messageContainer); } // Create alert element const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-2 shadow-sm`; alertDiv.setAttribute('role', 'alert'); alertDiv.setAttribute('data-auto-dismiss', '5000'); const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'; const title = type === 'success' ? 'Success!' : 'Error!'; alertDiv.innerHTML = ` <i class="bi ${icon} me-2"></i> <strong>${title}</strong> ${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> `; messageContainer.appendChild(alertDiv); // Auto-dismiss after 5 seconds => { if (alertDiv.parentNode) { const bsAlert = new bootstrap.Alert(alertDiv); bsAlert.close(); } }, 5000); } // Delete user function function deleteUser(userId, userName) { if (confirm(`Are you sure you want to delete the user "${userName}"? This will also remove all their roles and permissions. This action cannot be undone.`)) { fetch(`/api/super-admin/delete-user/${userId}/`, { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Content-Type': 'application/json', }, }) .then(response => response.json()) .then(data => { if (data.status === 'success') { // Show Bootstrap success message showMessage('success', `User "${userName}" deleted successfully`); // Remove the user card from the page => { location.reload(); }, 1500); } else { showMessage('danger', 'Error deleting user: ' + data.message); } }) .catch(error => { showMessage('danger', 'Error deleting user'); console.error('Error:', error); }); } } </script> <style> /* Status badge styles */ .status-badge { padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; color: white; } .status-active { background: var(--ios-green); } .status-inactive { background: var(--ios-red); } </style> {% endblock %} 