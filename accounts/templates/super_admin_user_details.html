{% extends 'base.html' %}

{% block title %}User Details - {{ user.get_full_name }} - RMS{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 48px;">
        <h1 style="font-size: 36px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; letter-spacing: -0.02em;">
            User Details
        </h1>
        <p style="color: var(--text-secondary); font-size: 17px; font-weight: 400;">
            Detailed information for {{ user.get_full_name }}
        </p>
    </div>

    <!-- Navigation -->
    <div style="margin-bottom: 32px;">
        <a href="{% url 'super_admin_manage_users' %}" 
           style="background: var(--surface-secondary); color: var(--text-primary); padding: 12px 24px; border: 1px solid var(--border-color); border-radius: 16px; text-decoration: none; font-weight: 500; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            ‚Üê Back to Users
        </a>
    </div>

    <!-- User Information Card -->
    <div class="ios-card" style="margin-bottom: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="color: var(--text-primary); font-size: 22px; font-weight: 600; margin: 0;">User Information</h2>
            <div style="display: flex; gap: 12px;">
                <a href="{% url 'super_admin_edit_user' user.id %}" class="btn btn-primary">Edit User</a>
                <button class="btn btn-danger delete-user-btn" data-user-id="{{ user.id }}">Delete User</button>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">Full Name</label>
                    <div style="font-size: 16px; color: var(--text-primary);">{{ user.get_full_name }}</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">Username</label>
                    <div style="font-size: 16px; color: var(--text-primary);">{{ user.username }}</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">Email</label>
                    <div style="font-size: 16px; color: var(--text-primary);">{{ user.email }}</div>
                </div>
            </div>
            
            <div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">Status</label>
                    <div style="font-size: 16px;">
                        {% if user.is_active %}
                            <span style="background: var(--ios-green); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Active</span>
                        {% else %}
                            <span style="background: var(--ios-red); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Inactive</span>
                        {% endif %}
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">Date Joined</label>
                    <div style="font-size: 16px; color: var(--text-primary);">{{ user.date_joined|date:"F d, Y" }}</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;">Last Login</label>
                    <div style="font-size: 16px; color: var(--text-primary);">
                        {% if user.last_login %}
                            {{ user.last_login|date:"F d, Y g:i A" }}
                        {% else %}
                            Never
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Roles Card -->
    <div class="ios-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="color: var(--text-primary); font-size: 22px; font-weight: 600; margin: 0;">User Roles</h2>
            <span style="background: var(--ios-blue-ultra-light); color: var(--ios-blue); padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                {{ user_roles.count }} Role{{ user_roles.count|pluralize }}
            </span>
        </div>
        
        {% if user_roles %}
            <div style="display: grid; gap: 16px;">
                {% for role in user_roles %}
                <div style="background: var(--surface-secondary); border: 1px solid var(--border-light); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="color: var(--ios-blue); margin-bottom: 8px; font-size: 18px; font-weight: 600;">
                                {{ role.get_role_display }}
                            </h3>
                            
                            {% if role.faculty %}
                                <div style="margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: var(--text-secondary); font-size: 14px;">Faculty:</span>
                                    <span style="color: var(--text-primary); font-size: 14px;">{{ role.faculty.name }}</span>
                                </div>
                            {% endif %}
                            
                            {% if role.department %}
                                <div style="margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: var(--text-secondary); font-size: 14px;">Department:</span>
                                    <span style="color: var(--text-primary); font-size: 14px;">{{ role.department.name }}</span>
                                </div>
                            {% endif %}
                            
                            <div style="margin-bottom: 8px;">
                                <span style="font-weight: 600; color: var(--text-secondary); font-size: 14px;">Assigned:</span>
                                <span style="color: var(--text-primary); font-size: 14px;">{{ role.created_at|date:"F d, Y" }}</span>
                            </div>
                            
                            {% if role.created_by %}
                                <div>
                                    <span style="font-weight: 600; color: var(--text-secondary); font-size: 14px;">Assigned by:</span>
                                    <span style="color: var(--text-primary); font-size: 14px;">{{ role.created_by.get_full_name }}</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <button class="btn btn-danger btn-sm delete-role-btn" data-role-id="{{ role.id }}">
                            Remove Role
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <div style="width: 60px; height: 60px; background: var(--ios-blue-ultra-light); border-radius: 15px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                    <div style="width: 30px; height: 30px; background: var(--ios-blue); border-radius: 8px; opacity: 0.6;"></div>
                </div>
                <p style="margin-bottom: 16px;">No roles assigned to this user</p>
                <a href="{% url 'super_admin_edit_user' user.id %}" class="btn btn-primary">Assign Roles</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            fetch(`/api/super-admin/delete-user/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('User deleted successfully');
                    window.location.href = '/api/super-admin/manage-users/';
                } else {
                    alert('Error deleting user: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error deleting user');
                console.error('Error:', error);
            });
        }
    }

    function deleteRole(roleId) {
        if (confirm('Are you sure you want to remove this role from the user?')) {
            fetch(`/api/super-admin/delete-role/${roleId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('Error removing role: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error removing role');
                console.error('Error:', error);
            });
        }
    }

    // Add event listeners for buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Delete user button
        const deleteUserBtn = document.querySelector('.delete-user-btn');
        if (deleteUserBtn) {
            deleteUserBtn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                deleteUser(userId);
            });
        }

        // Delete role buttons
        document.querySelectorAll('.delete-role-btn').forEach(button => {
            button.addEventListener('click', function() {
                const roleId = this.getAttribute('data-role-id');
                deleteRole(roleId);
            });
        });
    });
</script>

<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}

{% endblock %}
